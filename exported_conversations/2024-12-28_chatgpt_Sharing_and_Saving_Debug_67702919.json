{
  "id": "67702919-f748-8012-b323-6c5d03fa3a29",
  "source": "chatgpt",
  "title": "Sharing and Saving Debug",
  "created_at": "2024-12-28T17:36:42.085007",
  "updated_at": "2024-12-28T17:48:27.842760",
  "summary": null,
  "message_count": 8,
  "messages": [
    {
      "id": "10aa1d0a-0ffa-4052-9265-cdbe79e27977",
      "role": "user",
      "content": "",
      "created_at": null,
      "sequence_order": 0,
      "parent_id": "c8db5b1b-1c11-4a65-978b-b677745eaa13",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "aaa29f6d-077f-4ac2-9c9a-57c2720384dc",
      "role": "user",
      "content": "review this code, why isn't sharing working, also it says that i have to save the card before adding a promise except i thought once we were on the card page it should already be saved:\n\nhere is our schema from supabase:\n\nNameDescriptionData TypeFormat\n\nid\n\nNo description\n\nuuiduuid\n\nuser_id\n\nNo description\n\nuuiduuid\n\ncreated_at\n\nNo description\n\ntimestamp with time zonetimestamptz\n\nphoto_url\n\nNo description\n\ntexttext\n\nshare_key\n\nNo description\n\ntexttext\n\nis_public\n\nNo description\n\nbooleanbool\n\nemail\n\nNo description\n\ntexttext\n\nwants_reminders\n\nNo description\n\nbooleanbool\n\nshare_type\n\nNo description\n\ntexttext\n\nvalue_promise\n\nNo description\n\ntexttext\n\nattention_patterns\n\nNo description\n\njsonbjsonb\n\ndescription\n\nNo description\n\ntexttext\n\npractices\n\nNo description\n\njsonbjsonb\n\ntitle\n\nNo description\n\njsonbjsonb\n\nstory\n\nNo description\n\ntexttext{\n  \"files\": {\n    \"lib/supabase.ts\": \"// lib/supbase.ts \\nimport { createClient } from '@supabase/supabase-js'\\n\\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\\n\\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\",\n    \"lib/types.ts\": \"// lib/types.ts\\n\\nexport interface BaseReflection {\\n    moment: string;\\n    meaning: string;\\n    value: string;\\n    future_intention: string;\\n  }\\n  \\n  export interface ValuesCard {\\n    id?: string; // Optional for new cards\\n    created_at?: string;\\n    user_id?: string; // Optional since users can create without auth\\n    title: string;\\n    description: string;\\n    attention_patterns: string[];\\n    photo_url?: string;\\n    share_key?: string; // Only set if shared\\n    is_public: boolean;\\n    value_promise?: string; // Optional since it may not be set initially\\n  }\\n  \\n  export interface FriendPerspective {\\n    id: string;\\n    created_at: string;\\n    card_id: string;\\n    photo_url?: string;\\n    responses: {\\n      memory: string;      // When they saw you living this value\\n      observation: string; // What they noticed about you\\n      impact: string;      // How it affected them\\n      values_seen: string; // Values they observed\\n    };\\n  }\\n  export interface BaseReflection {\\n  moment: string;\\n  meaning: string;\\n  value: string;\\n  future_intention: string;\\n}\\n\\nexport interface ValuesCard extends BaseReflection {\\n  id: string;\\n  created_at: string;\\n  user_id?: string;\\n  photo_url?: string;\\n  share_key?: string;\\n  is_public: boolean;\\n  friend_perspectives?: FriendPerspective[];\\n}\",\n    \"lib/utils.ts\": \"// lib/utils.ts\\nimport { type ClassValue, clsx } from 'clsx';\\nimport { twMerge } from 'tailwind-merge';\\n\\nexport function cn(...inputs: ClassValue[]) {\\n  return twMerge(clsx(inputs));\\n}\",\n    \"app/layout.tsx\": \"// app/layout.tsx\\nimport type { Metadata } from \\\"next\\\";\\nimport { Geist, Geist_Mono } from \\\"next/font/google\\\";\\nimport \\\"./globals.css\\\";\\n\\nconst geistSans = Geist({\\n  variable: \\\"--font-geist-sans\\\",\\n  subsets: [\\\"latin\\\"],\\n});\\n\\nconst geistMono = Geist_Mono({\\n  variable: \\\"--font-geist-mono\\\",\\n  subsets: [\\\"latin\\\"],\\n});\\n\\nexport const metadata: Metadata = {\\n  title: \\\"Values Reflection Tool\\\",\\n  description: \\\"Discover and articulate your values through guided reflection\\\",\\n};\\n\\nexport default function RootLayout({\\n  children,\\n}: Readonly<{\\n  children: React.ReactNode;\\n}>) {\\n  return (\\n    <html lang=\\\"en\\\" suppressHydrationWarning>\\n      <body\\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\\n        suppressHydrationWarning\\n      >\\n        <div id=\\\"app-root\\\">{children}</div>\\n      </body>\\n    </html>\\n  );\\n}\",\n    \"app/page.tsx\": \"// app/page.tsx\\n'use client';\\n\\nimport { useRouter } from 'next/navigation';\\nimport { Button } from '@/components/ui/button';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\n\\nexport default function WelcomePage() {\\n  const router = useRouter();\\n  \\n  const startReflection = () => {\\n    router.push('/reflection');\\n  };\\n\\n  return (\\n<div className=\\\"min-h-screen bg-background py-12\\\">\\n  <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n    <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n      <header className=\\\"p-6 border-b border-gray-200\\\">\\n        <h1 className=\\\"text-3xl font-bold text-text-dark text-center\\\">\\n          Welcome to Your Reflection\\n        </h1>\\n      </header>\\n      <main className=\\\"p-cardPadding text-center\\\">\\n        <p className=\\\"text-text-light\\\">\\n          Reflect on your year by capturing meaningful moments and values.\\n        </p>\\n        <div className=\\\"mt-6\\\">\\n          <button\\n            className=\\\"bg-primary hover:bg-primary-dark text-white font-medium py-2 px-6 rounded-lg transition\\\"\\n            onClick={startReflection}\\n          >\\n            Start Reflection\\n          </button>\\n        </div>\\n      </main>\\n    </div>\\n  </div>\\n</div>\\n  );\\n}\",\n    \"app/reflection/page.tsx\": \"'use client';\\n\\nimport { useState } from 'react';\\nimport { useReflection } from '@/contexts/ReflectionContext';\\nimport { supabase } from '@/lib/supabase';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { ChatUI } from '@/components/reflection/shared/ChatUI';\\nimport { ValuesCard } from '@/components/reflection/ValuesCard';\\n\\nexport default function ReflectionPage() {\\n  const { state, updateState } = useReflection();\\n  const [story, setStory] = useState('');\\n  const [photoFile, setPhotoFile] = useState<File | null>(null);\\n  const [showChat, setShowChat] = useState(false);\\n\\n  const handleStorySubmit = async () => {\\n    let photo_url = '';\\n    if (photoFile) {\\n      const { data, error } = await supabase.storage\\n        .from('values-photos')\\n        .upload(`public/${Date.now()}-${photoFile.name}`, photoFile);\\n      \\n      if (!error && data) {\\n        const { data: urlData } = supabase.storage\\n          .from('values-photos')\\n          .getPublicUrl(data.path);\\n        photo_url = urlData.publicUrl;\\n      }\\n    }\\n\\n    updateState({ story, photo_url });\\n    setShowChat(true);\\n  };\\n\\n  const handleChatComplete = async (valuesCard: any) => {\\n    try {\\n      const { title, description, attention_patterns, practices } = valuesCard;\\n  \\n      // Save values card with story\\n      const { data, error } = await supabase.from('values_cards').insert([\\n        {\\n          title,\\n          description,\\n          attention_patterns,\\n          practices,\\n          story: state.story, // Use the saved story\\n          photo_url: state.photo_url,\\n          is_public: false,\\n        },\\n      ]).select().single();\\n\\n      if (error) throw error;\\n\\n      updateState({\\n        values_card: data,\\n        share_key: data.share_key,\\n      });\\n    } catch (err) {\\n      console.error('Error saving card:', err);\\n      alert('An error occurred while saving your values card. Please try again.');\\n    }\\n  };\\n\\n  const handleShare = (shareKey: string) => {\\n    updateState({ share_key: shareKey });\\n  };\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        {showChat || state.values_card ? (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Explore Your Values\\n              </h1>\\n            </header>\\n            <main className=\\\"p-cardPadding\\\">\\n              {showChat && !state.values_card && (\\n                <Card>\\n                  <CardHeader>\\n                    <h1 className=\\\"text-2xl font-bold text-gray-900\\\">Continue Your Story</h1>\\n                  </CardHeader>\\n                  <CardContent>\\n                    <ChatUI\\n                      onComplete={handleChatComplete}\\n                      className=\\\"min-h-[400px]\\\"\\n                      initialMessage={`Thank you for sharing this story: \\\"${story}\\\". Let's explore what makes it meaningful and the values it highlights. What stands out most to you about this experience?`}\\n                    />\\n                  </CardContent>\\n                </Card>\\n              )}\\n              {state.values_card && (\\n                <ValuesCard\\n                  {...state.values_card}\\n                  photo_url={state.photo_url}\\n                  onShare={handleShare}\\n                />\\n              )}\\n            </main>\\n          </div>\\n        ) : (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Share a Meaningful Story\\n              </h1>\\n            </header>\\n            <main className=\\\"p-cardPadding space-y-6\\\">\\n              <textarea\\n                value={story}\\n                onChange={(e) => setStory(e.target.value)}\\n                placeholder=\\\"Tell me about a meaningful experience...\\\"\\n                className=\\\"w-full p-4 rounded-lg border border-gray-300 bg-white text-black placeholder-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none\\\"\\n              />\\n              <div>\\n                <label className=\\\"block text-sm text-gray-700 mb-2\\\">Add a photo (optional):</label>\\n                <input\\n                  type=\\\"file\\\"\\n                  onChange={(e) => setPhotoFile(e.target.files?.[0] || null)}\\n                  className=\\\"text-sm text-gray-700\\\"\\n                />\\n              </div>\\n              <button\\n                onClick={handleStorySubmit}\\n                disabled={!story.trim()}\\n                className={`w-full py-2 rounded-lg font-medium transition ${\\n                  story.trim()\\n                    ? 'bg-blue-500 text-white hover:bg-blue-600'\\n                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'\\n                }`}\\n              >\\n                Continue\\n              </button>\\n            </main>\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\",\n    \"app/api/reflection/chat/route.ts\": \"// app/api/reflection/chat/route.ts\\n// app/api/reflection/chat/route.ts\\nimport OpenAI from 'openai';\\nimport { NextResponse } from 'next/server';\\n\\nconst openai = new OpenAI({\\n  apiKey: process.env.OPENAI_API_KEY!,\\n});\\n\\nconst systemPrompt = `You are a compassionate guide helping people discover their core values through meaningful moments. Your approach:\\n\\n1. Listen deeply to their story and reflect back what seems meaningful\\n2. Ask gentle, probing questions to explore deeper themes\\n3. Notice patterns and metaphors they use\\n4. Help identify what they pay attention to in these meaningful moments\\n\\nApproach:\\n- Use warmth and emotional mirroring\\n- Offer multiple interpretations to help them explore\\n- Build on metaphors they introduce\\n- Move gradually from story to structured insights\\n\\nFormat responses as a natural conversation, but work towards identifying:\\n- What they notice in meaningful moments\\n- What patterns of attention bring them alive\\n- What ways of being feel most authentic\\n\\nEnd goal is to help them articulate a clear values card with:\\n- A title capturing the essence\\n- 3-4 specific things they pay attention to\\n- Always grounded in their actual experience\\n\\nWhen they express clarity about a value, respond with:\\n<values-card>\\n{\\n  \\\"title\\\": \\\"Core value as a simple phrase\\\",\\n  \\\"description\\\": \\\"2-3 sentences connecting their story to this value\\\",\\n  \\\"attention_patterns\\\": [\\\"3-4 specific things they naturally notice or care about\\\"],\\n  \\\"practices\\\": [\\\"2-3 ways to live this value more fully\\\"]\\n}\\n</values-card>\\n\\nOtherwise, continue the natural conversation helping them explore what matters.`;\\n\\nexport async function POST(req: Request) {\\n  try {\\n    const { messages } = await req.json();\\n\\n    const completion = await openai.chat.completions.create({\\n      model: 'gpt-4-turbo',\\n      stream: true,\\n      messages: [\\n        { role: 'system', content: systemPrompt },\\n        ...messages,\\n      ],\\n    });\\n\\n    // Create a readable stream\\n    const stream = new ReadableStream({\\n      async start(controller) {\\n        try {\\n          for await (const chunk of completion) {\\n            const content = chunk.choices[0]?.delta?.content || '';\\n            if (content) {\\n              controller.enqueue(new TextEncoder().encode(content));\\n            }\\n          }\\n        } catch (err) {\\n          console.error('Error streaming response:', err);\\n          controller.error(err);\\n        } finally {\\n          controller.close();\\n        }\\n      },\\n    });\\n\\n    return new Response(stream, {\\n      headers: {\\n        'Content-Type': 'text/plain; charset=utf-8',\\n        'Cache-Control': 'no-cache',\\n      },\\n    });\\n  } catch (error) {\\n    console.error('Error in API route:', error);\\n    return NextResponse.json({ error: 'Failed to process the request' }, { status: 500 });\\n  }\\n}\",\n    \"components/reflection/ValuesCard.tsx\": \"'use client';\\n\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { useState } from 'react';\\nimport { supabase } from '@/lib/supabase';\\n\\ninterface ValuesCardProps {\\n  title: string;\\n  description: string;\\n  attention_patterns: string[];\\n  practices: string[];\\n  photo_url?: string;\\n  onShare?: (shareKey: string) => void;\\n}\\n\\nexport function ValuesCard({\\n  title,\\n  description,\\n  attention_patterns,\\n  practices,\\n  photo_url,\\n  onShare,\\n}: ValuesCardProps) {\\n  const [isSharing, setIsSharing] = useState(false);\\n  const [shareKey, setShareKey] = useState<string | null>(null);\\n  const [valuePromise, setValuePromise] = useState('');\\n  const [isEditingPromise, setIsEditingPromise] = useState(false);\\n  const [isImageModalOpen, setIsImageModalOpen] = useState(false);\\n\\n  const handleShare = async () => {\\n    setIsSharing(true);\\n    try {\\n      // First, check if we already have a share key\\n      if (shareKey) {\\n        setIsSharing(false);\\n        return;\\n      }\\n\\n      const { data, error } = await supabase\\n        .from('values_cards')\\n        .insert([{\\n          title,\\n          description,\\n          attention_patterns,\\n          practices,\\n          photo_url,\\n          value_promise: valuePromise,\\n          is_public: true\\n        }])\\n        .select()\\n        .single();\\n\\n      if (error) {\\n        throw error;\\n      }\\n      \\n      if (data?.share_key) {\\n        setShareKey(data.share_key);\\n        if (onShare) onShare(data.share_key);\\n      }\\n    } catch (err) {\\n      console.error('Database error:', err);\\n      alert('Sorry, there was an error sharing your card. Please try again.');\\n    } finally {\\n      setIsSharing(false);\\n    }\\n  };\\n\\n  \\n  const saveValuePromise = async () => {\\n    if (!shareKey) {\\n      alert('Card must be created before adding a promise.');\\n      return;\\n    }\\n  \\n    try {\\n      const { error } = await supabase\\n        .from('values_cards')\\n        .update({ value_promise: valuePromise })\\n        .eq('share_key', shareKey);\\n  \\n      if (error) throw error;\\n  \\n      // Update local state on successful save\\n      setIsEditingPromise(false);\\n    } catch (err) {\\n      console.error('Error saving promise:', err);\\n      alert('Sorry, there was an error saving your promise. Please try again.');\\n    }\\n  };\\n\\n  \\n  return (\\n    <>\\n      <Card className=\\\"w-full bg-white shadow-lg\\\">\\n        <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n          <h2 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{title}</h2>\\n        </CardHeader>\\n        <CardContent className=\\\"space-y-6 p-8\\\">\\n          {/* Image Section */}\\n          <div \\n            onClick={() => photo_url && setIsImageModalOpen(true)}\\n            className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n          >\\n            {photo_url ? (\\n              <img\\n                src={photo_url}\\n                alt=\\\"Meaningful moment\\\"\\n                className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n              />\\n            ) : (\\n              <div className=\\\"w-full h-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center\\\">\\n                <p className=\\\"text-gray-500 text-lg\\\">No image uploaded</p>\\n              </div>\\n            )}\\n          </div>\\n\\n          <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{description}</p>\\n\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What you pay attention to:</h3>\\n            <ul className=\\\"space-y-2\\\">\\n              {attention_patterns.map((pattern, i) => (\\n                <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                  <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                  {pattern}\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to live this value:</h3>\\n            <ul className=\\\"space-y-2\\\">\\n              {practices.map((practice, i) => (\\n                <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                  <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                  {practice}\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n\\n          {/* Value Promise Section */}\\n          <div className=\\\"space-y-3 border-t pt-6\\\">\\n            <div className=\\\"flex justify-between items-center\\\">\\n              <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Your Value Promise</h3>\\n              {!isEditingPromise && (\\n                <Button\\n                  onClick={() => setIsEditingPromise(true)}\\n                  variant=\\\"outline\\\"\\n                  size=\\\"sm\\\"\\n                >\\n                  Edit Promise\\n                </Button>\\n              )}\\n            </div>\\n\\n            {isEditingPromise ? (\\n              <div className=\\\"space-y-3\\\">\\n                <Textarea\\n                  value={valuePromise}\\n                  onChange={(e) => setValuePromise(e.target.value)}\\n                  placeholder=\\\"How will you bring this value to life in the coming year?\\\"\\n                  className=\\\"min-h-[100px]\\\"\\n                />\\n                <div className=\\\"flex gap-2\\\">\\n                  <Button\\n                    onClick={saveValuePromise}\\n                    className=\\\"flex-1 bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                  >\\n                    Save Promise\\n                  </Button>\\n                  <Button\\n                    onClick={() => setIsEditingPromise(false)}\\n                    variant=\\\"outline\\\"\\n                    className=\\\"flex-1\\\"\\n                  >\\n                    Cancel\\n                  </Button>\\n                </div>\\n              </div>\\n            ) : (\\n              <div className=\\\"bg-gray-50 p-4 rounded\\\">\\n                <p className=\\\"text-gray-700\\\">\\n                  {valuePromise || \\\"No promise added yet. Click 'Edit Promise' to add one.\\\"}\\n                </p>\\n              </div>\\n            )}\\n          </div>\\n\\n          {/* Share Section */}\\n          <div className=\\\"space-y-4 border-t pt-6\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <h3 className=\\\"font-semibold text-gray-900\\\">Share Your Values Card</h3>\\n              {!shareKey && (\\n                <Button\\n                  onClick={handleShare}\\n                  disabled={isSharing}\\n                  className=\\\"bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                >\\n                  {isSharing ? 'Creating Link...' : 'Create Share Link'}\\n                </Button>\\n              )}\\n            </div>\\n\\n            {shareKey && (\\n              <div className=\\\"bg-gray-50 p-4 rounded-lg space-y-4\\\">\\n                <div>\\n                  <p className=\\\"text-sm text-gray-600 mb-2\\\">\\n                    Share this link with friends to view your values card:\\n                  </p>\\n                  <code className=\\\"block w-full bg-white p-3 rounded border text-sm break-all\\\">\\n                    {`${window.location.origin}/card/${shareKey}`}\\n                  </code>\\n                </div>\\n                <div>\\n                  <p className=\\\"text-sm text-gray-600 mb-2\\\">\\n                    Share this link to get friends' perspectives on your values:\\n                  </p>\\n                  <code className=\\\"block w-full bg-white p-3 rounded border text-sm break-all\\\">\\n                    {`${window.location.origin}/friend/${shareKey}`}\\n                  </code>\\n                </div>\\n              </div>\\n            )}\\n          </div>\\n        </CardContent>\\n      </Card>\\n\\n      {/* Image Modal */}\\n      {isImageModalOpen && photo_url && (\\n        <div \\n          className=\\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\\\"\\n          onClick={() => setIsImageModalOpen(false)}\\n        >\\n          <div className=\\\"max-w-4xl w-full h-full relative\\\">\\n            <img\\n              src={photo_url}\\n              alt=\\\"Meaningful moment\\\"\\n              className=\\\"object-contain w-full h-full\\\"\\n            />\\n            <button\\n              className=\\\"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg\\\"\\n              onClick={() => setIsImageModalOpen(false)}\\n            >\\n              <svg className=\\\"w-6 h-6\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" viewBox=\\\"0 0 24 24\\\">\\n                <path strokeLinecap=\\\"round\\\" strokeLinejoin=\\\"round\\\" strokeWidth={2} d=\\\"M6 18L18 6M6 6l12 12\\\" />\\n              </svg>\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </>\\n  );\\n}\",\n    \"components/reflection/shared/ChatUI.tsx\": \"// components/reflection/shared/ChatUI.tsx\\n'use client';\\n\\nimport { useRef, useState, useEffect } from 'react';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { Send } from 'lucide-react';\\nimport { cn } from '@/lib/utils';\\n\\ninterface ChatUIProps {\\n  onComplete?: (valuesCard: any) => void;\\n  className?: string;\\n  initialMessage?: string;\\n}\\n\\nexport function ChatUI({ onComplete, className, initialMessage }: ChatUIProps) {\\n  const [messages, setMessages] = useState(\\n    initialMessage ? [{ role: 'assistant', content: initialMessage }] : []\\n  );\\n  const [input, setInput] = useState('');\\n  const [isThinking, setIsThinking] = useState(false);\\n  const chatEndRef = useRef<HTMLDivElement | null>(null);\\n\\n  // Scroll to bottom whenever messages are updated\\n  useEffect(() => {\\n    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });\\n  }, [messages]);\\n\\n  const handleMessage = (text: string) => {\\n    // Check for values card format\\n    const cardMatch = text.match(/<values-card>(.*?)<\\\\/values-card>/s);\\n    if (cardMatch) {\\n      try {\\n        const valuesCard = JSON.parse(cardMatch[1]);\\n        if (onComplete) {\\n          onComplete(valuesCard);\\n        }\\n        // Return just the confirmation message without the JSON\\n        return \\\"I've captured the values from our conversation in a card. Would you like to make a promise about how you'll live this value in the coming year?\\\";\\n      } catch (e) {\\n        console.error('Error parsing values card:', e);\\n      }\\n    }\\n    return text;\\n  };\\n\\n  const handleSendMessage = async () => {\\n    if (!input.trim()) return;\\n\\n    const userMessage = { role: 'user', content: input.trim() };\\n    setMessages(prev => [...prev, userMessage]);\\n    setInput('');\\n    setIsThinking(true);\\n\\n    try {\\n      const response = await fetch('/api/reflection/chat', {\\n        method: 'POST',\\n        headers: { 'Content-Type': 'application/json' },\\n        body: JSON.stringify({ \\n          messages: [...messages, userMessage]\\n        }),\\n      });\\n\\n      if (!response.body) return;\\n\\n      const reader = response.body.getReader();\\n      const decoder = new TextDecoder();\\n      let assistantMessage = '';\\n\\n      while (true) {\\n        const { done, value } = await reader.read();\\n        if (done) break;\\n        \\n        const chunk = decoder.decode(value, { stream: true });\\n        assistantMessage += chunk;\\n        \\n        // Process the message for display\\n        const displayMessage = handleMessage(assistantMessage);\\n        \\n        setMessages(prev => {\\n          const updated = [...prev];\\n          const lastMessage = updated[updated.length - 1];\\n          if (lastMessage.role === 'assistant') {\\n            lastMessage.content = displayMessage;\\n          } else {\\n            updated.push({ role: 'assistant', content: displayMessage });\\n          }\\n          return updated;\\n        });\\n      }\\n\\n    } catch (err) {\\n      console.error('Error:', err);\\n      setMessages(prev => [\\n        ...prev,\\n        { \\n          role: 'assistant', \\n          content: \\\"I'm sorry, I encountered an error. Please try again.\\\" \\n        }\\n      ]);\\n    } finally {\\n      setIsThinking(false);\\n    }\\n  };\\n\\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\\n    if (e.key === 'Enter' && !e.shiftKey) {\\n      e.preventDefault();\\n      handleSendMessage();\\n    }\\n  };\\n\\n  return (\\n    <div className={cn('flex flex-col space-y-4', className)}>\\n      <div className=\\\"flex-1 overflow-y-auto space-y-4 min-h-[300px] max-h-[500px] p-4 rounded-lg bg-white\\\">\\n        {messages.map((message, index) => (\\n          <div\\n            key={index}\\n            className={cn(\\n              'flex w-full',\\n              message.role === 'user' ? 'justify-end' : 'justify-start'\\n            )}\\n          >\\n            <div\\n              className={cn(\\n                'rounded-lg px-4 py-2 max-w-[80%]',\\n                message.role === 'user'\\n                  ? 'bg-blue-500 text-white'\\n                  : 'bg-gray-100 text-gray-900'\\n              )}\\n            >\\n              {message.content}\\n            </div>\\n          </div>\\n        ))}\\n        <div ref={chatEndRef} />\\n      </div>\\n\\n      <form\\n        onSubmit={(e) => {\\n          e.preventDefault();\\n          handleSendMessage();\\n        }}\\n        className=\\\"flex items-end gap-2\\\"\\n      >\\n        <Textarea\\n          value={input}\\n          onChange={(e) => setInput(e.target.value)}\\n          onKeyDown={handleKeyDown}\\n          placeholder=\\\"Share your thoughts...\\\"\\n          className=\\\"flex-1 min-h-[80px] p-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500\\\"\\n          disabled={isThinking}\\n        />\\n        <Button\\n          type=\\\"submit\\\"\\n          className=\\\"flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg\\\"\\n          disabled={isThinking || !input.trim()}\\n        >\\n          <Send className=\\\"w-4 h-4\\\" />\\n          {isThinking ? 'Thinking...' : 'Send'}\\n        </Button>\\n      </form>\\n    </div>\\n  );\\n}\",\n    \"contexts/ReflectionContext.tsx\": \"// contexts/ReflectionContext.tsx\\n'use client';\\n\\nimport { createContext, useContext, useState } from 'react';\\n\\ninterface ValuesCard {\\n  title: string;\\n  description: string;\\n  patterns: string[];\\n  suggested_practices: string[];\\n}\\n\\ninterface ReflectionState {\\n  story: string;\\n  photo_url?: string;\\n  values_card?: ValuesCard;\\n  share_key?: string;\\n}\\n\\nconst defaultState: ReflectionState = {\\n  story: '',\\n};\\n\\nconst ReflectionContext = createContext<{\\n  state: ReflectionState;\\n  updateState: (updates: Partial<ReflectionState>) => void;\\n} | null>(null);\\n\\nexport function ReflectionProvider({ children }: { children: React.ReactNode }) {\\n  const [state, setState] = useState<ReflectionState>(defaultState);\\n\\n  const updateState = (updates: Partial<ReflectionState>) => {\\n    setState(prev => ({\\n      ...prev,\\n      ...updates\\n    }));\\n  };\\n\\n  return (\\n    <ReflectionContext.Provider value={{ state, updateState }}>\\n      {children}\\n    </ReflectionContext.Provider>\\n  );\\n}\\n\\nexport const useReflection = () => {\\n  const context = useContext(ReflectionContext);\\n  if (!context) {\\n    throw new Error('useReflection must be used within a ReflectionProvider');\\n  }\\n  return context;\\n};\",\n    \"app/friend/[shareKey]/page.tsx\": \"// app/card/[shareKey]/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { useRouter } from 'next/navigation';\\nimport { supabase } from '@/lib/supabase';\\n\\ninterface FriendPerspective {\\n  id: string;\\n  memory: string;\\n  observation: string;\\n  impact: string;\\n  values_seen: string;\\n  created_at: string;\\n}\\n\\ninterface ValuesCard {\\n  title: string;\\n  description: string;\\n  attention_patterns: string[];\\n  practices: string[];\\n  photo_url?: string;\\n  value_promise?: string;\\n  friend_perspectives?: FriendPerspective[];\\n}\\n\\nexport default function CardViewPage({ params }: { params: { shareKey: string } }) {\\n  const [card, setCard] = useState<ValuesCard | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n  const [isImageModalOpen, setIsImageModalOpen] = useState(false);\\n  const router = useRouter();\\n\\n  useEffect(() => {\\n    async function loadCard() {\\n      try {\\n        const { data, error } = await supabase\\n          .from('values_cards')\\n          .select(`\\n            *,\\n            friend_perspectives (\\n              id,\\n              memory,\\n              observation,\\n              impact,\\n              values_seen,\\n              created_at\\n            )\\n          `)\\n          .eq('share_key', params.shareKey)\\n          .single();\\n\\n        if (error) throw error;\\n        if (data) {\\n          setCard(data as ValuesCard);\\n        }\\n      } catch (err) {\\n        console.error('Error loading card:', err);\\n        setError('Unable to load the values card');\\n      } finally {\\n        setLoading(false);\\n      }\\n    }\\n\\n    loadCard();\\n  }, [params.shareKey]);\\n\\n  const handleSharePerspective = () => {\\n    router.push(`/friend/${params.shareKey}`);\\n  };\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <div className=\\\"animate-pulse space-y-4\\\">\\n            <div className=\\\"h-12 bg-gray-200 rounded w-3/4 mx-auto\\\"></div>\\n            <div className=\\\"h-64 bg-gray-200 rounded\\\"></div>\\n            <div className=\\\"space-y-2\\\">\\n              <div className=\\\"h-4 bg-gray-200 rounded w-5/6\\\"></div>\\n              <div className=\\\"h-4 bg-gray-200 rounded w-4/6\\\"></div>\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  if (error || !card) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardContent className=\\\"p-8 text-center\\\">\\n              <h2 className=\\\"text-xl text-red-600 font-semibold\\\">\\n                {error || 'Values card not found'}\\n              </h2>\\n              <p className=\\\"text-gray-600 mt-2\\\">\\n                The card you're looking for might have been removed or the link might be incorrect.\\n              </p>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  return (\\n    <>\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n              <h1 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{card.title}</h1>\\n            </CardHeader>\\n            <CardContent className=\\\"space-y-6 p-8\\\">\\n              {/* Image Section */}\\n              {card.photo_url && (\\n                <div \\n                  onClick={() => setIsImageModalOpen(true)}\\n                  className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n                >\\n                  <img\\n                    src={card.photo_url}\\n                    alt=\\\"Meaningful moment\\\"\\n                    className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n                  />\\n                </div>\\n              )}\\n\\n              <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{card.description}</p>\\n\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What they pay attention to:</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.attention_patterns.map((pattern, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {pattern}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to live this value:</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.practices.map((practice, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {practice}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n\\n              {card.value_promise && (\\n                <div className=\\\"space-y-3 border-t pt-6\\\">\\n                  <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Their Value Promise</h3>\\n                  <div className=\\\"bg-gray-50 p-4 rounded\\\">\\n                    <p className=\\\"text-gray-700\\\">{card.value_promise}</p>\\n                  </div>\\n                </div>\\n              )}\\n\\n              {/* Friend Perspectives Section */}\\n              <div className=\\\"space-y-4 border-t pt-6\\\">\\n                <div className=\\\"flex justify-between items-center\\\">\\n                  <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Friend Perspectives</h3>\\n                  <Button\\n                    onClick={handleSharePerspective}\\n                    className=\\\"bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                  >\\n                    Share Your Perspective\\n                  </Button>\\n                </div>\\n\\n                {card.friend_perspectives && card.friend_perspectives.length > 0 ? (\\n                  <div className=\\\"space-y-6\\\">\\n                    {card.friend_perspectives.map((perspective) => (\\n                      <div key={perspective.id} className=\\\"bg-gray-50 p-6 rounded-lg space-y-4\\\">\\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">A Moment They Noticed</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.memory}</p>\\n                        </div>\\n                        \\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">What They Observed</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.observation}</p>\\n                        </div>\\n\\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">The Impact</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.impact}</p>\\n                        </div>\\n\\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">Values They Saw</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.values_seen}</p>\\n                        </div>\\n\\n                        <div className=\\\"text-sm text-gray-500\\\">\\n                          Shared on {new Date(perspective.created_at).toLocaleDateString()}\\n                        </div>\\n                      </div>\\n                    ))}\\n                  </div>\\n                ) : (\\n                  <div className=\\\"text-center py-8 bg-gray-50 rounded-lg\\\">\\n                    <p className=\\\"text-gray-600\\\">No perspectives shared yet.</p>\\n                    <p className=\\\"text-gray-600 mt-2\\\">\\n                      Be the first to share what you value about them!\\n                    </p>\\n                  </div>\\n                )}\\n              </div>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n\\n      {/* Image Modal */}\\n      {isImageModalOpen && card.photo_url && (\\n        <div \\n          className=\\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\\\"\\n          onClick={() => setIsImageModalOpen(false)}\\n        >\\n          <div className=\\\"max-w-4xl w-full h-full relative\\\">\\n            <img\\n              src={card.photo_url}\\n              alt=\\\"Meaningful moment\\\"\\n              className=\\\"object-contain w-full h-full\\\"\\n            />\\n            <button\\n              className=\\\"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg\\\"\\n              onClick={(e) => {\\n                e.stopPropagation();\\n                setIsImageModalOpen(false);\\n              }}\\n            >\\n              <svg className=\\\"w-6 h-6\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" viewBox=\\\"0 0 24 24\\\">\\n                <path strokeLinecap=\\\"round\\\" strokeLinejoin=\\\"round\\\" strokeWidth={2} d=\\\"M6 18L18 6M6 6l12 12\\\" />\\n              </svg>\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </>\\n  );\\n}\",\n    \"app/card/[shareKey]/page.tsx\": \"// app/card/[shareKey]/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { supabase } from '@/lib/supabase';\\n\\ninterface ValuesCard {\\n  id: string;\\n  created_at: string;\\n  story: string;\\n  description: string;\\n  attention_patterns: string[];\\n  practices: string[];\\n  photo_url?: string;\\n  share_key?: string;\\n  is_public: boolean;\\n}\\n\\nexport default function CardViewPage({ params }: { params: { shareKey: string } }) {\\n  const [card, setCard] = useState<ValuesCard | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n  const [isImageModalOpen, setIsImageModalOpen] = useState(false);\\n\\n  useEffect(() => {\\n    async function loadCard() {\\n        try {\\n          const { data, error } = await supabase\\n            .from('values_cards')\\n            .select(`\\n              id,\\n              created_at,\\n              story,\\n              description,  // Updated field name\\n              attention_patterns,\\n              practices,\\n              photo_url,\\n              share_key,\\n              is_public\\n            `)\\n            .eq('share_key', params.shareKey)\\n            .limit(1) // Ensure only one row is returned\\n            .single();\\n      \\n          if (error) throw error;\\n          if (data) {\\n            setCard(data as ValuesCard);\\n          }\\n        } catch (err) {\\n          console.error('Error loading card:', err);\\n          setError(\\n            err.message === 'JSON object requested, multiple (or no) rows returned'\\n              ? 'No matching values card found, or multiple entries exist.'\\n              : 'Unable to load the values card'\\n          );\\n        } finally {\\n          setLoading(false);\\n        }\\n      }\\n      \\n    loadCard();\\n  }, [params.shareKey]);\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <div className=\\\"animate-pulse space-y-4\\\">\\n            <div className=\\\"h-12 bg-gray-200 rounded w-3/4 mx-auto\\\"></div>\\n            <div className=\\\"h-64 bg-gray-200 rounded\\\"></div>\\n            <div className=\\\"space-y-2\\\">\\n              <div className=\\\"h-4 bg-gray-200 rounded w-5/6\\\"></div>\\n              <div className=\\\"h-4 bg-gray-200 rounded w-4/6\\\"></div>\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  if (error || !card) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardContent className=\\\"p-8 text-center\\\">\\n              <h2 className=\\\"text-xl text-red-600 font-semibold\\\">\\n                {error || 'Values card not found'}\\n              </h2>\\n              <p className=\\\"text-gray-600 mt-2\\\">\\n                The card you're looking for might have been removed or the link might be incorrect.\\n              </p>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  return (\\n    <>\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n              <h1 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{card.description}</h1>\\n            </CardHeader>\\n            <CardContent className=\\\"space-y-6 p-8\\\">\\n              {/* Image Section */}\\n              {card.photo_url && (\\n                <div \\n                  onClick={() => setIsImageModalOpen(true)}\\n                  className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n                >\\n                  <img\\n                    src={card.photo_url}\\n                    alt=\\\"Value-related photo\\\"\\n                    className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n                  />\\n                </div>\\n              )}\\n\\n              {/* Story Section */}\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Story</h3>\\n                <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{card.story}</p>\\n              </div>\\n\\n              {/* Attention Patterns Section */}\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What You Pay Attention To</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.attention_patterns.map((pattern, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {pattern}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n\\n              {/* Practices Section */}\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to Live This Value</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.practices.map((practice, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {practice}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n\\n      {/* Image Modal */}\\n      {isImageModalOpen && card.photo_url && (\\n        <div \\n          className=\\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\\\"\\n          onClick={() => setIsImageModalOpen(false)}\\n        >\\n          <div className=\\\"max-w-4xl w-full h-full relative\\\">\\n            <img\\n              src={card.photo_url}\\n              alt=\\\"Value-related photo\\\"\\n              className=\\\"object-contain w-full h-full\\\"\\n            />\\n            <button\\n              className=\\\"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg\\\"\\n              onClick={(e) => {\\n                e.stopPropagation();\\n                setIsImageModalOpen(false);\\n              }}\\n            >\\n              <svg className=\\\"w-6 h-6\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" viewBox=\\\"0 0 24 24\\\">\\n                <path strokeLinecap=\\\"round\\\" strokeLinejoin=\\\"round\\\" strokeWidth={2} d=\\\"M6 18L18 6M6 6l12 12\\\" />\\n              </svg>\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </>\\n  );\\n}\\n\\n\"\n  },\n  \"dependencies\": {\n    \"dependencies\": {\n      \"@headlessui/react\": \"^2.2.0\",\n      \"@heroicons/react\": \"^2.2.0\",\n      \"@supabase/auth-helpers-nextjs\": \"^0.10.0\",\n      \"@supabase/supabase-js\": \"^2.47.10\",\n      \"ai\": \"^4.0.22\",\n      \"class-variance-authority\": \"^0.7.1\",\n      \"clsx\": \"^2.1.1\",\n      \"lucide-react\": \"^0.469.0\",\n      \"next\": \"15.1.3\",\n      \"openai\": \"^4.77.0\",\n      \"react\": \"^19.0.0\",\n      \"react-dom\": \"^19.0.0\",\n      \"tailwind-merge\": \"^2.6.0\",\n      \"vercel\": \"^39.2.2\"\n    },\n    \"devDependencies\": {\n      \"@eslint/eslintrc\": \"^3\",\n      \"@types/node\": \"^20\",\n      \"@types/react\": \"^19\",\n      \"@types/react-dom\": \"^19\",\n      \"eslint\": \"^9\",\n      \"eslint-config-next\": \"15.1.3\",\n      \"postcss\": \"^8\",\n      \"tailwindcss\": \"^3.4.1\",\n      \"typescript\": \"^5\"\n    }\n  },\n  \"missingFiles\": []\n}",
      "created_at": "2024-12-28T17:36:42.089317",
      "sequence_order": 1,
      "parent_id": "10aa1d0a-0ffa-4052-9265-cdbe79e27977",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "3c9bf77f-5f32-4e90-bb40-5bbf00cb6bb7",
      "role": "assistant",
      "content": "",
      "created_at": "2024-12-28T17:36:59.907566",
      "sequence_order": 2,
      "parent_id": "aaa29f6d-077f-4ac2-9c9a-57c2720384dc",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "9c4649d9-80a2-4446-af4a-87c238f8f7d4",
      "role": "assistant",
      "content": "To debug the sharing functionality and the issue with needing to save the card before adding a promise, here are some observations and suggestions:\n\n### **Problems and Debugging Steps**\n\n1. **Sharing Functionality (`handleShare`)**\n   - **Problem**: If `shareKey` is `null`, the `handleShare` function tries to insert the values card to the database with `is_public: true`. This action assumes the card does not yet exist. However, if there are conflicts or mismanagement of the `share_key` field in your schema or logic, the key might not be generated or saved properly.\n   - **Debugging**:\n     - Ensure that the `share_key` is being generated in your Supabase database when a card is inserted.\n     - Check the database constraints or triggers on the `share_key` column. If this is supposed to be auto-generated, validate the logic in the database.\n     - Add logging after the database insert to confirm the returned `share_key`.\n\n     ```ts\n     const { data, error } = await supabase\n       .from('values_cards')\n       .insert([{\n         title,\n         description,\n         attention_patterns,\n         practices,\n         photo_url,\n         value_promise: valuePromise,\n         is_public: true,\n       }])\n       .select()\n       .single();\n\n     if (error) {\n       console.error(\"Insert Error:\", error.message);\n       return;\n     }\n\n     console.log(\"Inserted Data:\", data);\n     ```\n\n2. **Saving the Card Before Adding a Promise**\n   - **Problem**: The `saveValuePromise` function explicitly checks for `shareKey` before updating the card. If the card has not been saved (or if the `shareKey` is not returned or persisted correctly), this function will fail.\n   - **Debugging**:\n     - Ensure the card is saved before the user attempts to add a promise. You might need to refactor your workflow so the card is always saved first, and its `id` or `share_key` is persisted in the state.\n     - Validate the presence of `share_key` in the state. If it is missing after saving, verify that it is returned from Supabase and properly stored.\n\n     ```ts\n     if (!shareKey) {\n       console.warn('Share key not available, cannot save promise');\n       alert('Card must be created before adding a promise.');\n       return;\n     }\n     ```\n\n### **Code Review and Suggested Fixes**\n\n1. **Ensure Card is Saved When Navigating to its Page**\n   - Add a call to save the card if it doesn't already exist when users start interacting with the `ReflectionPage`.\n\n     ```ts\n     const saveCardOnStart = async () => {\n       if (!state.values_card) {\n         const { data, error } = await supabase.from('values_cards').insert({\n           title: \"New Reflection\",\n           description: \"\",\n           is_public: false,\n         }).select().single();\n\n         if (data) {\n           updateState({ values_card: data });\n         }\n       }\n     };\n\n     useEffect(() => {\n       saveCardOnStart();\n     }, []);\n     ```\n\n2. **Resolve `shareKey` Logic in `ValuesCard` Component**\n   - Modify the `handleShare` function to ensure it retrieves the `share_key` after saving the card, even if the card was already created.\n\n     ```ts\n     const handleShare = async () => {\n       setIsSharing(true);\n       try {\n         let data;\n         if (!shareKey) {\n           const result = await supabase\n             .from('values_cards')\n             .insert([{ title, description, attention_patterns, practices, photo_url, value_promise: valuePromise, is_public: true }])\n             .select()\n             .single();\n\n           data = result.data;\n           if (result.error) throw result.error;\n         } else {\n           const result = await supabase\n             .from('values_cards')\n             .select('share_key')\n             .eq('id', cardId)\n             .single();\n\n           data = result.data;\n           if (result.error) throw result.error;\n         }\n\n         setShareKey(data.share_key);\n         onShare?.(data.share_key);\n       } catch (err) {\n         console.error('Error sharing card:', err);\n       } finally {\n         setIsSharing(false);\n       }\n     };\n     ```\n\n3. **Supabase Schema Validation**\n   - Check that the `share_key` column is correctly configured to auto-generate or allow null values for initial creation. If auto-generating, ensure a trigger is creating the `share_key` upon row insertion.\n\n4. **State Management**\n   - Confirm that `ReflectionContext` is correctly propagating updates to the state for `values_card` and `share_key`.\n\n### **General Suggestions**\n- **Centralize Error Handling**: Add consistent error-handling functions to handle database failures gracefully.\n- **Unit Tests**: Write tests for these functions using mock responses to ensure all edge cases are covered.\n- **Debug Logs**: Add temporary logs to track database interactions and UI states during development.\n\nBy addressing these areas, you should be able to fix the sharing functionality and ensure the card is saved properly before adding additional promises.",
      "created_at": "2024-12-28T17:36:59.907697",
      "sequence_order": 3,
      "parent_id": "3c9bf77f-5f32-4e90-bb40-5bbf00cb6bb7",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": true
      }
    },
    {
      "id": "aaa2bc7e-a2c0-460f-8501-7575d37774da",
      "role": "user",
      "content": "does this fix it? {\n  \"files\": {\n    \"lib/supabase.ts\": \"// lib/supbase.ts \\nimport { createClient } from '@supabase/supabase-js'\\n\\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\\n\\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\",\n    \"lib/types.ts\": \"// lib/types.ts\\n\\nexport interface BaseReflection {\\n    moment: string;\\n    meaning: string;\\n    value: string;\\n    future_intention: string;\\n  }\\n  \\n  export interface ValuesCard {\\n    id?: string; // Optional for new cards\\n    created_at?: string;\\n    user_id?: string; // Optional since users can create without auth\\n    title: string;\\n    description: string;\\n    attention_patterns: string[];\\n    photo_url?: string;\\n    share_key?: string; // Only set if shared\\n    is_public: boolean;\\n    value_promise?: string; // Optional since it may not be set initially\\n  }\\n  \\n  export interface FriendPerspective {\\n    id: string;\\n    created_at: string;\\n    card_id: string;\\n    photo_url?: string;\\n    responses: {\\n      memory: string;      // When they saw you living this value\\n      observation: string; // What they noticed about you\\n      impact: string;      // How it affected them\\n      values_seen: string; // Values they observed\\n    };\\n  }\\n  export interface BaseReflection {\\n  moment: string;\\n  meaning: string;\\n  value: string;\\n  future_intention: string;\\n}\\n\\nexport interface ValuesCard extends BaseReflection {\\n  id: string;\\n  created_at: string;\\n  user_id?: string;\\n  photo_url?: string;\\n  share_key?: string;\\n  is_public: boolean;\\n  friend_perspectives?: FriendPerspective[];\\n}\",\n    \"lib/utils.ts\": \"// lib/utils.ts\\nimport { type ClassValue, clsx } from 'clsx';\\nimport { twMerge } from 'tailwind-merge';\\n\\nexport function cn(...inputs: ClassValue[]) {\\n  return twMerge(clsx(inputs));\\n}\",\n    \"app/layout.tsx\": \"// app/layout.tsx\\nimport type { Metadata } from \\\"next\\\";\\nimport { Geist, Geist_Mono } from \\\"next/font/google\\\";\\nimport \\\"./globals.css\\\";\\n\\nconst geistSans = Geist({\\n  variable: \\\"--font-geist-sans\\\",\\n  subsets: [\\\"latin\\\"],\\n});\\n\\nconst geistMono = Geist_Mono({\\n  variable: \\\"--font-geist-mono\\\",\\n  subsets: [\\\"latin\\\"],\\n});\\n\\nexport const metadata: Metadata = {\\n  title: \\\"Values Reflection Tool\\\",\\n  description: \\\"Discover and articulate your values through guided reflection\\\",\\n};\\n\\nexport default function RootLayout({\\n  children,\\n}: Readonly<{\\n  children: React.ReactNode;\\n}>) {\\n  return (\\n    <html lang=\\\"en\\\" suppressHydrationWarning>\\n      <body\\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\\n        suppressHydrationWarning\\n      >\\n        <div id=\\\"app-root\\\">{children}</div>\\n      </body>\\n    </html>\\n  );\\n}\",\n    \"app/page.tsx\": \"// app/page.tsx\\n'use client';\\n\\nimport { useRouter } from 'next/navigation';\\nimport { Button } from '@/components/ui/button';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\n\\nexport default function WelcomePage() {\\n  const router = useRouter();\\n  \\n  const startReflection = () => {\\n    router.push('/reflection');\\n  };\\n\\n  return (\\n<div className=\\\"min-h-screen bg-background py-12\\\">\\n  <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n    <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n      <header className=\\\"p-6 border-b border-gray-200\\\">\\n        <h1 className=\\\"text-3xl font-bold text-text-dark text-center\\\">\\n          Welcome to Your Reflection\\n        </h1>\\n      </header>\\n      <main className=\\\"p-cardPadding text-center\\\">\\n        <p className=\\\"text-text-light\\\">\\n          Reflect on your year by capturing meaningful moments and values.\\n        </p>\\n        <div className=\\\"mt-6\\\">\\n          <button\\n            className=\\\"bg-primary hover:bg-primary-dark text-white font-medium py-2 px-6 rounded-lg transition\\\"\\n            onClick={startReflection}\\n          >\\n            Start Reflection\\n          </button>\\n        </div>\\n      </main>\\n    </div>\\n  </div>\\n</div>\\n  );\\n}\",\n    \"app/reflection/page.tsx\": \"//app/reflection/page.tsx \\n'use client';\\n\\nimport { useState } from 'react';\\nimport { useReflection } from '@/contexts/ReflectionContext';\\nimport { supabase } from '@/lib/supabase';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { ChatUI } from '@/components/reflection/shared/ChatUI';\\nimport { ValuesCard } from '@/components/reflection/ValuesCard';\\n\\nexport default function ReflectionPage() {\\n  const { state, updateState } = useReflection();\\n  const [story, setStory] = useState('');\\n  const [photoFile, setPhotoFile] = useState<File | null>(null);\\n  const [showChat, setShowChat] = useState(false);\\n\\n  const handleStorySubmit = async () => {\\n    let photo_url = '';\\n    if (photoFile) {\\n      const { data, error } = await supabase.storage\\n        .from('values-photos')\\n        .upload(`public/${Date.now()}-${photoFile.name}`, photoFile);\\n      \\n      if (!error && data) {\\n        const { data: urlData } = supabase.storage\\n          .from('values-photos')\\n          .getPublicUrl(data.path);\\n        photo_url = urlData.publicUrl;\\n      }\\n    }\\n\\n    updateState({ story, photo_url });\\n    setShowChat(true);\\n  };\\n\\n  const handleChatComplete = async (valuesCard: any) => {\\n    try {\\n      const { title, description, attention_patterns, practices } = valuesCard;\\n  \\n      // Save values card with story\\n      const { data, error } = await supabase.from('values_cards').insert([\\n        {\\n          title,\\n          description,\\n          attention_patterns,\\n          practices,\\n          story: state.story, // Use the saved story\\n          photo_url: state.photo_url,\\n          is_public: false,\\n        },\\n      ]).select().single();\\n\\n      if (error) throw error;\\n\\n      updateState({\\n        values_card: data,\\n        share_key: data.share_key,\\n      });\\n    } catch (err) {\\n      console.error('Error saving card:', err);\\n      alert('An error occurred while saving your values card. Please try again.');\\n    }\\n  };\\n\\n  const handleShare = (shareKey: string) => {\\n    updateState({ share_key: shareKey });\\n  };\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        {showChat || state.values_card ? (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Explore Your Values\\n              </h1>\\n            </header>\\n            <main className=\\\"p-cardPadding\\\">\\n              {showChat && !state.values_card && (\\n                <Card>\\n                  <CardHeader>\\n                    <h1 className=\\\"text-2xl font-bold text-gray-900\\\">Continue Your Story</h1>\\n                  </CardHeader>\\n                  <CardContent>\\n                    <ChatUI\\n                      onComplete={handleChatComplete}\\n                      className=\\\"min-h-[400px]\\\"\\n                      initialMessage={`Thank you for sharing this story: \\\"${story}\\\". Let's explore what makes it meaningful and the values it highlights. What stands out most to you about this experience?`}\\n                    />\\n                  </CardContent>\\n                </Card>\\n              )}\\n              {state.values_card && (\\n                <ValuesCard\\n                id={state.values_card.id}  // Pass the id\\n                title={state.values_card.title}\\n                description={state.values_card.description}\\n                attention_patterns={state.values_card.attention_patterns}\\n                practices={state.values_card.practices}\\n                photo_url={state.photo_url}\\n                onShare={handleShare}\\n              />\\n              )}\\n            </main>\\n          </div>\\n        ) : (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Share a Meaningful Story\\n              </h1>\\n            </header>\\n            <main className=\\\"p-cardPadding space-y-6\\\">\\n              <textarea\\n                value={story}\\n                onChange={(e) => setStory(e.target.value)}\\n                placeholder=\\\"Tell me about a meaningful experience...\\\"\\n                className=\\\"w-full p-4 rounded-lg border border-gray-300 bg-white text-black placeholder-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none\\\"\\n              />\\n              <div>\\n                <label className=\\\"block text-sm text-gray-700 mb-2\\\">Add a photo (optional):</label>\\n                <input\\n                  type=\\\"file\\\"\\n                  onChange={(e) => setPhotoFile(e.target.files?.[0] || null)}\\n                  className=\\\"text-sm text-gray-700\\\"\\n                />\\n              </div>\\n              <button\\n                onClick={handleStorySubmit}\\n                disabled={!story.trim()}\\n                className={`w-full py-2 rounded-lg font-medium transition ${\\n                  story.trim()\\n                    ? 'bg-blue-500 text-white hover:bg-blue-600'\\n                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'\\n                }`}\\n              >\\n                Continue\\n              </button>\\n            </main>\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\",\n    \"app/api/reflection/chat/route.ts\": \"// app/api/reflection/chat/route.ts\\n// app/api/reflection/chat/route.ts\\nimport OpenAI from 'openai';\\nimport { NextResponse } from 'next/server';\\n\\nconst openai = new OpenAI({\\n  apiKey: process.env.OPENAI_API_KEY!,\\n});\\n\\nconst systemPrompt = `You are a compassionate guide helping people discover their core values through meaningful moments. Your approach:\\n\\n1. Listen deeply to their story and reflect back what seems meaningful\\n2. Ask gentle, probing questions to explore deeper themes\\n3. Notice patterns and metaphors they use\\n4. Help identify what they pay attention to in these meaningful moments\\n\\nApproach:\\n- Use warmth and emotional mirroring\\n- Offer multiple interpretations to help them explore\\n- Build on metaphors they introduce\\n- Move gradually from story to structured insights\\n\\nFormat responses as a natural conversation, but work towards identifying:\\n- What they notice in meaningful moments\\n- What patterns of attention bring them alive\\n- What ways of being feel most authentic\\n\\nEnd goal is to help them articulate a clear values card with:\\n- A title capturing the essence\\n- 3-4 specific things they pay attention to\\n- Always grounded in their actual experience\\n\\nWhen they express clarity about a value, respond with:\\n<values-card>\\n{\\n  \\\"title\\\": \\\"Core value as a simple phrase\\\",\\n  \\\"description\\\": \\\"2-3 sentences connecting their story to this value\\\",\\n  \\\"attention_patterns\\\": [\\\"3-4 specific things they naturally notice or care about\\\"],\\n  \\\"practices\\\": [\\\"2-3 ways to live this value more fully\\\"]\\n}\\n</values-card>\\n\\nOtherwise, continue the natural conversation helping them explore what matters.`;\\n\\nexport async function POST(req: Request) {\\n  try {\\n    const { messages } = await req.json();\\n\\n    const completion = await openai.chat.completions.create({\\n      model: 'gpt-4-turbo',\\n      stream: true,\\n      messages: [\\n        { role: 'system', content: systemPrompt },\\n        ...messages,\\n      ],\\n    });\\n\\n    // Create a readable stream\\n    const stream = new ReadableStream({\\n      async start(controller) {\\n        try {\\n          for await (const chunk of completion) {\\n            const content = chunk.choices[0]?.delta?.content || '';\\n            if (content) {\\n              controller.enqueue(new TextEncoder().encode(content));\\n            }\\n          }\\n        } catch (err) {\\n          console.error('Error streaming response:', err);\\n          controller.error(err);\\n        } finally {\\n          controller.close();\\n        }\\n      },\\n    });\\n\\n    return new Response(stream, {\\n      headers: {\\n        'Content-Type': 'text/plain; charset=utf-8',\\n        'Cache-Control': 'no-cache',\\n      },\\n    });\\n  } catch (error) {\\n    console.error('Error in API route:', error);\\n    return NextResponse.json({ error: 'Failed to process the request' }, { status: 500 });\\n  }\\n}\",\n    \"components/reflection/ValuesCard.tsx\": \"'use client';\\n\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { useState } from 'react';\\nimport { supabase } from '@/lib/supabase';\\n\\ninterface ValuesCardProps {\\n    id?: string;  // Add id to props\\n    title: string;\\n    description: string;\\n    attention_patterns: string[];\\n    practices: string[];\\n    photo_url?: string;\\n    onShare?: (shareKey: string) => void;\\n  }\\n  \\n  export function ValuesCard({\\n    id,  // Get id from props\\n    title,\\n    description,\\n    attention_patterns,\\n    practices,\\n    photo_url,\\n    onShare,\\n  }: ValuesCardProps) {\\n    const [isSharing, setIsSharing] = useState(false);\\n    const [shareKey, setShareKey] = useState<string | null>(null);\\n    const [valuePromise, setValuePromise] = useState('');\\n    const [isEditingPromise, setIsEditingPromise] = useState(false);\\n  \\n    const handleShare = async () => {\\n      setIsSharing(true);\\n      try {\\n        // First, check if we already have a share key\\n        if (shareKey) {\\n          setIsSharing(false);\\n          return;\\n        }\\n  \\n        // Generate a share key\\n        const newShareKey = crypto.randomUUID();\\n        \\n        const { data, error } = await supabase\\n          .from('values_cards')\\n          .update({\\n            share_key: newShareKey,\\n            is_public: true\\n          })\\n          .eq('id', id)  // Use the id to update the correct card\\n          .select()\\n          .single();\\n  \\n        if (error) {\\n          throw error;\\n        }\\n        \\n        if (data?.share_key) {\\n          setShareKey(data.share_key);\\n          if (onShare) onShare(data.share_key);\\n        }\\n      } catch (err) {\\n        console.error('Database error:', err);\\n        alert('Sorry, there was an error sharing your card. Please try again.');\\n      } finally {\\n        setIsSharing(false);\\n      }\\n    };\\n  \\n    const saveValuePromise = async () => {\\n      try {\\n        const { error } = await supabase\\n          .from('values_cards')\\n          .update({ value_promise: valuePromise })\\n          .eq('id', id);  // Use the id to update the correct card\\n  \\n        if (error) throw error;\\n  \\n        setIsEditingPromise(false);\\n      } catch (err) {\\n        console.error('Error saving promise:', err);\\n        alert('Sorry, there was an error saving your promise. Please try again.');\\n      }\\n    };\\n  \\n\\n  \\n  return (\\n    <>\\n      <Card className=\\\"w-full bg-white shadow-lg\\\">\\n        <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n          <h2 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{title}</h2>\\n        </CardHeader>\\n        <CardContent className=\\\"space-y-6 p-8\\\">\\n          {/* Image Section */}\\n          <div \\n            onClick={() => photo_url && setIsImageModalOpen(true)}\\n            className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n          >\\n            {photo_url ? (\\n              <img\\n                src={photo_url}\\n                alt=\\\"Meaningful moment\\\"\\n                className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n              />\\n            ) : (\\n              <div className=\\\"w-full h-full bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center\\\">\\n                <p className=\\\"text-gray-500 text-lg\\\">No image uploaded</p>\\n              </div>\\n            )}\\n          </div>\\n\\n          <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{description}</p>\\n\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What you pay attention to:</h3>\\n            <ul className=\\\"space-y-2\\\">\\n              {attention_patterns.map((pattern, i) => (\\n                <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                  <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                  {pattern}\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to live this value:</h3>\\n            <ul className=\\\"space-y-2\\\">\\n              {practices.map((practice, i) => (\\n                <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                  <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                  {practice}\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n\\n          {/* Value Promise Section */}\\n          <div className=\\\"space-y-3 border-t pt-6\\\">\\n            <div className=\\\"flex justify-between items-center\\\">\\n              <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Your Value Promise</h3>\\n              {!isEditingPromise && (\\n                <Button\\n                  onClick={() => setIsEditingPromise(true)}\\n                  variant=\\\"outline\\\"\\n                  size=\\\"sm\\\"\\n                >\\n                  Edit Promise\\n                </Button>\\n              )}\\n            </div>\\n\\n            {isEditingPromise ? (\\n              <div className=\\\"space-y-3\\\">\\n                <Textarea\\n                  value={valuePromise}\\n                  onChange={(e) => setValuePromise(e.target.value)}\\n                  placeholder=\\\"How will you bring this value to life in the coming year?\\\"\\n                  className=\\\"min-h-[100px]\\\"\\n                />\\n                <div className=\\\"flex gap-2\\\">\\n                  <Button\\n                    onClick={saveValuePromise}\\n                    className=\\\"flex-1 bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                  >\\n                    Save Promise\\n                  </Button>\\n                  <Button\\n                    onClick={() => setIsEditingPromise(false)}\\n                    variant=\\\"outline\\\"\\n                    className=\\\"flex-1\\\"\\n                  >\\n                    Cancel\\n                  </Button>\\n                </div>\\n              </div>\\n            ) : (\\n              <div className=\\\"bg-gray-50 p-4 rounded\\\">\\n                <p className=\\\"text-gray-700\\\">\\n                  {valuePromise || \\\"No promise added yet. Click 'Edit Promise' to add one.\\\"}\\n                </p>\\n              </div>\\n            )}\\n          </div>\\n\\n          {/* Share Section */}\\n          <div className=\\\"space-y-4 border-t pt-6\\\">\\n            <div className=\\\"flex items-center justify-between\\\">\\n              <h3 className=\\\"font-semibold text-gray-900\\\">Share Your Values Card</h3>\\n              {!shareKey && (\\n                <Button\\n                  onClick={handleShare}\\n                  disabled={isSharing}\\n                  className=\\\"bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                >\\n                  {isSharing ? 'Creating Link...' : 'Create Share Link'}\\n                </Button>\\n              )}\\n            </div>\\n\\n            {shareKey && (\\n              <div className=\\\"bg-gray-50 p-4 rounded-lg space-y-4\\\">\\n                <div>\\n                  <p className=\\\"text-sm text-gray-600 mb-2\\\">\\n                    Share this link with friends to view your values card:\\n                  </p>\\n                  <code className=\\\"block w-full bg-white p-3 rounded border text-sm break-all\\\">\\n                    {`${window.location.origin}/card/${shareKey}`}\\n                  </code>\\n                </div>\\n                <div>\\n                  <p className=\\\"text-sm text-gray-600 mb-2\\\">\\n                    Share this link to get friends' perspectives on your values:\\n                  </p>\\n                  <code className=\\\"block w-full bg-white p-3 rounded border text-sm break-all\\\">\\n                    {`${window.location.origin}/friend/${shareKey}`}\\n                  </code>\\n                </div>\\n              </div>\\n            )}\\n          </div>\\n        </CardContent>\\n      </Card>\\n\\n      {/* Image Modal */}\\n      {isImageModalOpen && photo_url && (\\n        <div \\n          className=\\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\\\"\\n          onClick={() => setIsImageModalOpen(false)}\\n        >\\n          <div className=\\\"max-w-4xl w-full h-full relative\\\">\\n            <img\\n              src={photo_url}\\n              alt=\\\"Meaningful moment\\\"\\n              className=\\\"object-contain w-full h-full\\\"\\n            />\\n            <button\\n              className=\\\"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg\\\"\\n              onClick={() => setIsImageModalOpen(false)}\\n            >\\n              <svg className=\\\"w-6 h-6\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" viewBox=\\\"0 0 24 24\\\">\\n                <path strokeLinecap=\\\"round\\\" strokeLinejoin=\\\"round\\\" strokeWidth={2} d=\\\"M6 18L18 6M6 6l12 12\\\" />\\n              </svg>\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </>\\n  );\\n}\",\n    \"components/reflection/shared/ChatUI.tsx\": \"// components/reflection/shared/ChatUI.tsx\\n'use client';\\n\\nimport { useRef, useState, useEffect } from 'react';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { Send } from 'lucide-react';\\nimport { cn } from '@/lib/utils';\\n\\ninterface ChatUIProps {\\n  onComplete?: (valuesCard: any) => void;\\n  className?: string;\\n  initialMessage?: string;\\n}\\n\\nexport function ChatUI({ onComplete, className, initialMessage }: ChatUIProps) {\\n  const [messages, setMessages] = useState(\\n    initialMessage ? [{ role: 'assistant', content: initialMessage }] : []\\n  );\\n  const [input, setInput] = useState('');\\n  const [isThinking, setIsThinking] = useState(false);\\n  const chatEndRef = useRef<HTMLDivElement | null>(null);\\n\\n  // Scroll to bottom whenever messages are updated\\n  useEffect(() => {\\n    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });\\n  }, [messages]);\\n\\n  const handleMessage = (text: string) => {\\n    // Check for values card format\\n    const cardMatch = text.match(/<values-card>(.*?)<\\\\/values-card>/s);\\n    if (cardMatch) {\\n      try {\\n        const valuesCard = JSON.parse(cardMatch[1]);\\n        if (onComplete) {\\n          onComplete(valuesCard);\\n        }\\n        // Return just the confirmation message without the JSON\\n        return \\\"I've captured the values from our conversation in a card. Would you like to make a promise about how you'll live this value in the coming year?\\\";\\n      } catch (e) {\\n        console.error('Error parsing values card:', e);\\n      }\\n    }\\n    return text;\\n  };\\n\\n  const handleSendMessage = async () => {\\n    if (!input.trim()) return;\\n\\n    const userMessage = { role: 'user', content: input.trim() };\\n    setMessages(prev => [...prev, userMessage]);\\n    setInput('');\\n    setIsThinking(true);\\n\\n    try {\\n      const response = await fetch('/api/reflection/chat', {\\n        method: 'POST',\\n        headers: { 'Content-Type': 'application/json' },\\n        body: JSON.stringify({ \\n          messages: [...messages, userMessage]\\n        }),\\n      });\\n\\n      if (!response.body) return;\\n\\n      const reader = response.body.getReader();\\n      const decoder = new TextDecoder();\\n      let assistantMessage = '';\\n\\n      while (true) {\\n        const { done, value } = await reader.read();\\n        if (done) break;\\n        \\n        const chunk = decoder.decode(value, { stream: true });\\n        assistantMessage += chunk;\\n        \\n        // Process the message for display\\n        const displayMessage = handleMessage(assistantMessage);\\n        \\n        setMessages(prev => {\\n          const updated = [...prev];\\n          const lastMessage = updated[updated.length - 1];\\n          if (lastMessage.role === 'assistant') {\\n            lastMessage.content = displayMessage;\\n          } else {\\n            updated.push({ role: 'assistant', content: displayMessage });\\n          }\\n          return updated;\\n        });\\n      }\\n\\n    } catch (err) {\\n      console.error('Error:', err);\\n      setMessages(prev => [\\n        ...prev,\\n        { \\n          role: 'assistant', \\n          content: \\\"I'm sorry, I encountered an error. Please try again.\\\" \\n        }\\n      ]);\\n    } finally {\\n      setIsThinking(false);\\n    }\\n  };\\n\\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\\n    if (e.key === 'Enter' && !e.shiftKey) {\\n      e.preventDefault();\\n      handleSendMessage();\\n    }\\n  };\\n\\n  return (\\n    <div className={cn('flex flex-col space-y-4', className)}>\\n      <div className=\\\"flex-1 overflow-y-auto space-y-4 min-h-[300px] max-h-[500px] p-4 rounded-lg bg-white\\\">\\n        {messages.map((message, index) => (\\n          <div\\n            key={index}\\n            className={cn(\\n              'flex w-full',\\n              message.role === 'user' ? 'justify-end' : 'justify-start'\\n            )}\\n          >\\n            <div\\n              className={cn(\\n                'rounded-lg px-4 py-2 max-w-[80%]',\\n                message.role === 'user'\\n                  ? 'bg-blue-500 text-white'\\n                  : 'bg-gray-100 text-gray-900'\\n              )}\\n            >\\n              {message.content}\\n            </div>\\n          </div>\\n        ))}\\n        <div ref={chatEndRef} />\\n      </div>\\n\\n      <form\\n        onSubmit={(e) => {\\n          e.preventDefault();\\n          handleSendMessage();\\n        }}\\n        className=\\\"flex items-end gap-2\\\"\\n      >\\n        <Textarea\\n          value={input}\\n          onChange={(e) => setInput(e.target.value)}\\n          onKeyDown={handleKeyDown}\\n          placeholder=\\\"Share your thoughts...\\\"\\n          className=\\\"flex-1 min-h-[80px] p-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500\\\"\\n          disabled={isThinking}\\n        />\\n        <Button\\n          type=\\\"submit\\\"\\n          className=\\\"flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg\\\"\\n          disabled={isThinking || !input.trim()}\\n        >\\n          <Send className=\\\"w-4 h-4\\\" />\\n          {isThinking ? 'Thinking...' : 'Send'}\\n        </Button>\\n      </form>\\n    </div>\\n  );\\n}\",\n    \"contexts/ReflectionContext.tsx\": \"// contexts/ReflectionContext.tsx\\n'use client';\\n\\nimport { createContext, useContext, useState } from 'react';\\n\\ninterface ValuesCard {\\n  title: string;\\n  description: string;\\n  patterns: string[];\\n  suggested_practices: string[];\\n}\\n\\ninterface ReflectionState {\\n  story: string;\\n  photo_url?: string;\\n  values_card?: ValuesCard;\\n  share_key?: string;\\n}\\n\\nconst defaultState: ReflectionState = {\\n  story: '',\\n};\\n\\nconst ReflectionContext = createContext<{\\n  state: ReflectionState;\\n  updateState: (updates: Partial<ReflectionState>) => void;\\n} | null>(null);\\n\\nexport function ReflectionProvider({ children }: { children: React.ReactNode }) {\\n  const [state, setState] = useState<ReflectionState>(defaultState);\\n\\n  const updateState = (updates: Partial<ReflectionState>) => {\\n    setState(prev => ({\\n      ...prev,\\n      ...updates\\n    }));\\n  };\\n\\n  return (\\n    <ReflectionContext.Provider value={{ state, updateState }}>\\n      {children}\\n    </ReflectionContext.Provider>\\n  );\\n}\\n\\nexport const useReflection = () => {\\n  const context = useContext(ReflectionContext);\\n  if (!context) {\\n    throw new Error('useReflection must be used within a ReflectionProvider');\\n  }\\n  return context;\\n};\",\n    \"app/friend/[shareKey]/page.tsx\": \"// app/card/[shareKey]/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { useRouter } from 'next/navigation';\\nimport { supabase } from '@/lib/supabase';\\n\\ninterface FriendPerspective {\\n  id: string;\\n  memory: string;\\n  observation: string;\\n  impact: string;\\n  values_seen: string;\\n  created_at: string;\\n}\\n\\ninterface ValuesCard {\\n  title: string;\\n  description: string;\\n  attention_patterns: string[];\\n  practices: string[];\\n  photo_url?: string;\\n  value_promise?: string;\\n  friend_perspectives?: FriendPerspective[];\\n}\\n\\nexport default function CardViewPage({ params }: { params: { shareKey: string } }) {\\n  const [card, setCard] = useState<ValuesCard | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n  const [isImageModalOpen, setIsImageModalOpen] = useState(false);\\n  const router = useRouter();\\n\\n  useEffect(() => {\\n    async function loadCard() {\\n      try {\\n        const { data, error } = await supabase\\n          .from('values_cards')\\n          .select(`\\n            *,\\n            friend_perspectives (\\n              id,\\n              memory,\\n              observation,\\n              impact,\\n              values_seen,\\n              created_at\\n            )\\n          `)\\n          .eq('share_key', params.shareKey)\\n          .single();\\n\\n        if (error) throw error;\\n        if (data) {\\n          setCard(data as ValuesCard);\\n        }\\n      } catch (err) {\\n        console.error('Error loading card:', err);\\n        setError('Unable to load the values card');\\n      } finally {\\n        setLoading(false);\\n      }\\n    }\\n\\n    loadCard();\\n  }, [params.shareKey]);\\n\\n  const handleSharePerspective = () => {\\n    router.push(`/friend/${params.shareKey}`);\\n  };\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <div className=\\\"animate-pulse space-y-4\\\">\\n            <div className=\\\"h-12 bg-gray-200 rounded w-3/4 mx-auto\\\"></div>\\n            <div className=\\\"h-64 bg-gray-200 rounded\\\"></div>\\n            <div className=\\\"space-y-2\\\">\\n              <div className=\\\"h-4 bg-gray-200 rounded w-5/6\\\"></div>\\n              <div className=\\\"h-4 bg-gray-200 rounded w-4/6\\\"></div>\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  if (error || !card) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardContent className=\\\"p-8 text-center\\\">\\n              <h2 className=\\\"text-xl text-red-600 font-semibold\\\">\\n                {error || 'Values card not found'}\\n              </h2>\\n              <p className=\\\"text-gray-600 mt-2\\\">\\n                The card you're looking for might have been removed or the link might be incorrect.\\n              </p>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  return (\\n    <>\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n              <h1 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{card.title}</h1>\\n            </CardHeader>\\n            <CardContent className=\\\"space-y-6 p-8\\\">\\n              {/* Image Section */}\\n              {card.photo_url && (\\n                <div \\n                  onClick={() => setIsImageModalOpen(true)}\\n                  className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n                >\\n                  <img\\n                    src={card.photo_url}\\n                    alt=\\\"Meaningful moment\\\"\\n                    className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n                  />\\n                </div>\\n              )}\\n\\n              <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{card.description}</p>\\n\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What they pay attention to:</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.attention_patterns.map((pattern, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {pattern}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to live this value:</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.practices.map((practice, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {practice}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n\\n              {card.value_promise && (\\n                <div className=\\\"space-y-3 border-t pt-6\\\">\\n                  <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Their Value Promise</h3>\\n                  <div className=\\\"bg-gray-50 p-4 rounded\\\">\\n                    <p className=\\\"text-gray-700\\\">{card.value_promise}</p>\\n                  </div>\\n                </div>\\n              )}\\n\\n              {/* Friend Perspectives Section */}\\n              <div className=\\\"space-y-4 border-t pt-6\\\">\\n                <div className=\\\"flex justify-between items-center\\\">\\n                  <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Friend Perspectives</h3>\\n                  <Button\\n                    onClick={handleSharePerspective}\\n                    className=\\\"bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                  >\\n                    Share Your Perspective\\n                  </Button>\\n                </div>\\n\\n                {card.friend_perspectives && card.friend_perspectives.length > 0 ? (\\n                  <div className=\\\"space-y-6\\\">\\n                    {card.friend_perspectives.map((perspective) => (\\n                      <div key={perspective.id} className=\\\"bg-gray-50 p-6 rounded-lg space-y-4\\\">\\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">A Moment They Noticed</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.memory}</p>\\n                        </div>\\n                        \\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">What They Observed</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.observation}</p>\\n                        </div>\\n\\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">The Impact</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.impact}</p>\\n                        </div>\\n\\n                        <div>\\n                          <h4 className=\\\"font-medium text-gray-900\\\">Values They Saw</h4>\\n                          <p className=\\\"text-gray-700 mt-1\\\">{perspective.values_seen}</p>\\n                        </div>\\n\\n                        <div className=\\\"text-sm text-gray-500\\\">\\n                          Shared on {new Date(perspective.created_at).toLocaleDateString()}\\n                        </div>\\n                      </div>\\n                    ))}\\n                  </div>\\n                ) : (\\n                  <div className=\\\"text-center py-8 bg-gray-50 rounded-lg\\\">\\n                    <p className=\\\"text-gray-600\\\">No perspectives shared yet.</p>\\n                    <p className=\\\"text-gray-600 mt-2\\\">\\n                      Be the first to share what you value about them!\\n                    </p>\\n                  </div>\\n                )}\\n              </div>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n\\n      {/* Image Modal */}\\n      {isImageModalOpen && card.photo_url && (\\n        <div \\n          className=\\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\\\"\\n          onClick={() => setIsImageModalOpen(false)}\\n        >\\n          <div className=\\\"max-w-4xl w-full h-full relative\\\">\\n            <img\\n              src={card.photo_url}\\n              alt=\\\"Meaningful moment\\\"\\n              className=\\\"object-contain w-full h-full\\\"\\n            />\\n            <button\\n              className=\\\"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg\\\"\\n              onClick={(e) => {\\n                e.stopPropagation();\\n                setIsImageModalOpen(false);\\n              }}\\n            >\\n              <svg className=\\\"w-6 h-6\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" viewBox=\\\"0 0 24 24\\\">\\n                <path strokeLinecap=\\\"round\\\" strokeLinejoin=\\\"round\\\" strokeWidth={2} d=\\\"M6 18L18 6M6 6l12 12\\\" />\\n              </svg>\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </>\\n  );\\n}\",\n    \"app/card/[shareKey]/page.tsx\": \"// app/card/[shareKey]/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { supabase } from '@/lib/supabase';\\n\\ninterface ValuesCard {\\n  id: string;\\n  created_at: string;\\n  story: string;\\n  description: string;\\n  attention_patterns: string[];\\n  practices: string[];\\n  photo_url?: string;\\n  share_key?: string;\\n  is_public: boolean;\\n}\\n\\nexport default function CardViewPage({ params }: { params: { shareKey: string } }) {\\n  const [card, setCard] = useState<ValuesCard | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n  const [isImageModalOpen, setIsImageModalOpen] = useState(false);\\n\\n  useEffect(() => {\\n    async function loadCard() {\\n        try {\\n          const { data, error } = await supabase\\n            .from('values_cards')\\n            .select(`\\n              id,\\n              created_at,\\n              story,\\n              description,  // Updated field name\\n              attention_patterns,\\n              practices,\\n              photo_url,\\n              share_key,\\n              is_public\\n            `)\\n            .eq('share_key', params.shareKey)\\n            .limit(1) // Ensure only one row is returned\\n            .single();\\n      \\n          if (error) throw error;\\n          if (data) {\\n            setCard(data as ValuesCard);\\n          }\\n        } catch (err) {\\n          console.error('Error loading card:', err);\\n          setError(\\n            err.message === 'JSON object requested, multiple (or no) rows returned'\\n              ? 'No matching values card found, or multiple entries exist.'\\n              : 'Unable to load the values card'\\n          );\\n        } finally {\\n          setLoading(false);\\n        }\\n      }\\n      \\n    loadCard();\\n  }, [params.shareKey]);\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <div className=\\\"animate-pulse space-y-4\\\">\\n            <div className=\\\"h-12 bg-gray-200 rounded w-3/4 mx-auto\\\"></div>\\n            <div className=\\\"h-64 bg-gray-200 rounded\\\"></div>\\n            <div className=\\\"space-y-2\\\">\\n              <div className=\\\"h-4 bg-gray-200 rounded w-5/6\\\"></div>\\n              <div className=\\\"h-4 bg-gray-200 rounded w-4/6\\\"></div>\\n            </div>\\n          </div>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  if (error || !card) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardContent className=\\\"p-8 text-center\\\">\\n              <h2 className=\\\"text-xl text-red-600 font-semibold\\\">\\n                {error || 'Values card not found'}\\n              </h2>\\n              <p className=\\\"text-gray-600 mt-2\\\">\\n                The card you're looking for might have been removed or the link might be incorrect.\\n              </p>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  return (\\n    <>\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n              <h1 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{card.description}</h1>\\n            </CardHeader>\\n            <CardContent className=\\\"space-y-6 p-8\\\">\\n              {/* Image Section */}\\n              {card.photo_url && (\\n                <div \\n                  onClick={() => setIsImageModalOpen(true)}\\n                  className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n                >\\n                  <img\\n                    src={card.photo_url}\\n                    alt=\\\"Value-related photo\\\"\\n                    className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n                  />\\n                </div>\\n              )}\\n\\n              {/* Story Section */}\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Story</h3>\\n                <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{card.story}</p>\\n              </div>\\n\\n              {/* Attention Patterns Section */}\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What You Pay Attention To</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.attention_patterns.map((pattern, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {pattern}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n\\n              {/* Practices Section */}\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to Live This Value</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {card.practices.map((practice, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {practice}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n\\n      {/* Image Modal */}\\n      {isImageModalOpen && card.photo_url && (\\n        <div \\n          className=\\\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\\\"\\n          onClick={() => setIsImageModalOpen(false)}\\n        >\\n          <div className=\\\"max-w-4xl w-full h-full relative\\\">\\n            <img\\n              src={card.photo_url}\\n              alt=\\\"Value-related photo\\\"\\n              className=\\\"object-contain w-full h-full\\\"\\n            />\\n            <button\\n              className=\\\"absolute top-4 right-4 bg-white rounded-full p-2 shadow-lg\\\"\\n              onClick={(e) => {\\n                e.stopPropagation();\\n                setIsImageModalOpen(false);\\n              }}\\n            >\\n              <svg className=\\\"w-6 h-6\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" viewBox=\\\"0 0 24 24\\\">\\n                <path strokeLinecap=\\\"round\\\" strokeLinejoin=\\\"round\\\" strokeWidth={2} d=\\\"M6 18L18 6M6 6l12 12\\\" />\\n              </svg>\\n            </button>\\n          </div>\\n        </div>\\n      )}\\n    </>\\n  );\\n}\\n\\n\"\n  },\n  \"dependencies\": {\n    \"dependencies\": {\n      \"@headlessui/react\": \"^2.2.0\",\n      \"@heroicons/react\": \"^2.2.0\",\n      \"@supabase/auth-helpers-nextjs\": \"^0.10.0\",\n      \"@supabase/supabase-js\": \"^2.47.10\",\n      \"ai\": \"^4.0.22\",\n      \"class-variance-authority\": \"^0.7.1\",\n      \"clsx\": \"^2.1.1\",\n      \"lucide-react\": \"^0.469.0\",\n      \"next\": \"15.1.3\",\n      \"openai\": \"^4.77.0\",\n      \"react\": \"^19.0.0\",\n      \"react-dom\": \"^19.0.0\",\n      \"tailwind-merge\": \"^2.6.0\",\n      \"vercel\": \"^39.2.2\"\n    },\n    \"devDependencies\": {\n      \"@eslint/eslintrc\": \"^3\",\n      \"@types/node\": \"^20\",\n      \"@types/react\": \"^19\",\n      \"@types/react-dom\": \"^19\",\n      \"eslint\": \"^9\",\n      \"eslint-config-next\": \"15.1.3\",\n      \"postcss\": \"^8\",\n      \"tailwindcss\": \"^3.4.1\",\n      \"typescript\": \"^5\"\n    }\n  },\n  \"missingFiles\": []\n}",
      "created_at": "2024-12-28T17:41:44.178945",
      "sequence_order": 4,
      "parent_id": "9c4649d9-80a2-4446-af4a-87c238f8f7d4",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "3cb16819-0464-420e-8e4e-0b5784dec668",
      "role": "assistant",
      "content": "From the provided code and dependencies, this setup looks well-organized and likely functional. However, to confirm if the issues are fixed, here are key points to double-check:\n\n### 1. **Environment Variables**\nEnsure that the required environment variables (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `OPENAI_API_KEY`) are correctly configured in your `.env` file and available in your runtime environment.\n\n### 2. **Dependencies Compatibility**\nVerify that all dependencies are compatible with each other, especially:\n- `next` version `15.1.3`\n- `react` and `react-dom` version `19.0.0`\n- `@supabase/supabase-js` version `2.47.10`\n\nRun `npm install` or `yarn install` after adding these dependencies to ensure they are correctly resolved.\n\n### 3. **Supabase Integration**\n- Check that the Supabase instance (`supabase`) is correctly initialized in `lib/supabase.ts`.\n- Verify that the database schema matches the expected queries (e.g., `values_cards` and `values-photos` storage bucket exist and are correctly configured).\n\n### 4. **File Imports**\nEnsure all imports in the files are valid and point to the correct paths. For instance, the `ReflectionContext` and `ValuesCard` components should be correctly referenced.\n\n### 5. **Routing**\nEnsure your Next.js routes (`app/reflection`, `app/card/[shareKey]`, `app/friend/[shareKey]`) are correctly set up. Test navigation between pages to confirm they work as expected.\n\n### 6. **API Integration**\n- Check if the OpenAI API is responding correctly in `/api/reflection/chat/route.ts`. You may log the responses or test the endpoint independently using tools like Postman.\n\n### 7. **UI Components**\nValidate the Tailwind CSS setup (`tailwind.config.js`) and ensure all classes (e.g., `bg-card`, `text-text-dark`) are defined and rendering correctly.\n\n### 8. **Error Handling**\nEnsure robust error handling for:\n- File uploads in `supabase.storage.from`.\n- Database operations like `.insert` and `.update`.\n\n### 9. **Testing**\nRun your development server with:\n```bash\nnpm run dev\n```\nThen navigate through the app and test each functionality, including:\n- Uploading photos.\n- Generating and sharing a values card.\n- Using the chat interface with OpenAI.\n\n### Final Debugging Steps:\n- Use browser developer tools to catch any frontend errors.\n- Check the console for logs and adjust error handling as needed.\n- Confirm that API responses and database transactions are as expected.\n\nIf everything is set up and the environment variables are correct, this structure should function well! Let me know if any specific part still raises issues or behaves unexpectedly.",
      "created_at": "2024-12-28T17:42:04.254136",
      "sequence_order": 5,
      "parent_id": "aaa2bc7e-a2c0-460f-8501-7575d37774da",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": true
      }
    },
    {
      "id": "aaa20243-31e1-4dfe-ae88-54e84753847b",
      "role": "user",
      "content": "how can i get the text curor to be in the text box on the when i go to the ai chat page?",
      "created_at": "2024-12-28T17:48:02.353069",
      "sequence_order": 6,
      "parent_id": "3cb16819-0464-420e-8e4e-0b5784dec668",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "44980bd9-4de0-4b4d-a2e1-b87053253366",
      "role": "assistant",
      "content": "To ensure the text cursor is automatically focused in the input text box when the AI chat page loads, you can use the `useRef` and `useEffect` hooks in React. Here's how you can do it:\n\n### Update `ChatUI.tsx`\n\n1. **Add a reference to the text area:**\n   Use the `useRef` hook to reference the input text area.\n\n2. **Focus on the text area when the component mounts:**\n   Use the `useEffect` hook to set the focus on the text area when the component renders.\n\nHere's the updated `ChatUI.tsx`:\n\n```tsx\n'use client';\n\nimport { useRef, useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Send } from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\ninterface ChatUIProps {\n  onComplete?: (valuesCard: any) => void;\n  className?: string;\n  initialMessage?: string;\n}\n\nexport function ChatUI({ onComplete, className, initialMessage }: ChatUIProps) {\n  const [messages, setMessages] = useState(\n    initialMessage ? [{ role: 'assistant', content: initialMessage }] : []\n  );\n  const [input, setInput] = useState('');\n  const [isThinking, setIsThinking] = useState(false);\n  const chatEndRef = useRef<HTMLDivElement | null>(null);\n  const inputRef = useRef<HTMLTextAreaElement | null>(null);\n\n  // Scroll to bottom whenever messages are updated\n  useEffect(() => {\n    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  // Focus the input text area when the component mounts\n  useEffect(() => {\n    inputRef.current?.focus();\n  }, []);\n\n  const handleSendMessage = async () => {\n    if (!input.trim()) return;\n\n    const userMessage = { role: 'user', content: input.trim() };\n    setMessages((prev) => [...prev, userMessage]);\n    setInput('');\n    setIsThinking(true);\n\n    try {\n      const response = await fetch('/api/reflection/chat', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          messages: [...messages, userMessage],\n        }),\n      });\n\n      if (!response.body) return;\n\n      const reader = response.body.getReader();\n      const decoder = new TextDecoder();\n      let assistantMessage = '';\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        const chunk = decoder.decode(value, { stream: true });\n        assistantMessage += chunk;\n\n        setMessages((prev) => [\n          ...prev,\n          { role: 'assistant', content: assistantMessage },\n        ]);\n      }\n    } catch (err) {\n      console.error('Error:', err);\n      setMessages((prev) => [\n        ...prev,\n        {\n          role: 'assistant',\n          content: \"I'm sorry, I encountered an error. Please try again.\",\n        },\n      ]);\n    } finally {\n      setIsThinking(false);\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n\n  return (\n    <div className={cn('flex flex-col space-y-4', className)}>\n      <div className=\"flex-1 overflow-y-auto space-y-4 min-h-[300px] max-h-[500px] p-4 rounded-lg bg-white\">\n        {messages.map((message, index) => (\n          <div\n            key={index}\n            className={cn(\n              'flex w-full',\n              message.role === 'user' ? 'justify-end' : 'justify-start'\n            )}\n          >\n            <div\n              className={cn(\n                'rounded-lg px-4 py-2 max-w-[80%]',\n                message.role === 'user'\n                  ? 'bg-blue-500 text-white'\n                  : 'bg-gray-100 text-gray-900'\n              )}\n            >\n              {message.content}\n            </div>\n          </div>\n        ))}\n        <div ref={chatEndRef} />\n      </div>\n\n      <form\n        onSubmit={(e) => {\n          e.preventDefault();\n          handleSendMessage();\n        }}\n        className=\"flex items-end gap-2\"\n      >\n        <Textarea\n          ref={inputRef} // Attach the ref here\n          value={input}\n          onChange={(e) => setInput(e.target.value)}\n          onKeyDown={handleKeyDown}\n          placeholder=\"Share your thoughts...\"\n          className=\"flex-1 min-h-[80px] p-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n          disabled={isThinking}\n        />\n        <Button\n          type=\"submit\"\n          className=\"flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg\"\n          disabled={isThinking || !input.trim()}\n        >\n          <Send className=\"w-4 h-4\" />\n          {isThinking ? 'Thinking...' : 'Send'}\n        </Button>\n      </form>\n    </div>\n  );\n}\n```\n\n### Key Changes:\n1. **Added `inputRef`:**\n   This references the `Textarea` component.\n2. **Used `useEffect` to Focus:**\n   When the component mounts, the `useEffect` hook calls `inputRef.current?.focus()` to automatically place the cursor in the text area.\n\nNow, when the user navigates to the AI chat page, the cursor will be in the text box, ready for input.",
      "created_at": "2024-12-28T17:48:26.892650",
      "sequence_order": 7,
      "parent_id": "aaa20243-31e1-4dfe-ae88-54e84753847b",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": true
      }
    }
  ]
}