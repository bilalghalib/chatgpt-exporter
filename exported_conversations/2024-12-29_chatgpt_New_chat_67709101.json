{
  "id": "67709101-29a4-8012-a06e-75cc57eeaa5a",
  "source": "chatgpt",
  "title": "New chat",
  "created_at": "2024-12-29T01:00:01.726334",
  "updated_at": "2024-12-29T01:00:44.866669",
  "summary": null,
  "message_count": 4,
  "messages": [
    {
      "id": "97c7a16a-020e-4893-8240-0317604dfbcc",
      "role": "user",
      "content": "",
      "created_at": null,
      "sequence_order": 0,
      "parent_id": "c83c70db-8044-43c7-9d06-cb35d79fb7d3",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "aaa21107-a881-452e-884a-0195015fec3e",
      "role": "user",
      "content": "what's the difference between session id and share key and do we need two can we unify them, return all code in full files to update, i'm having issues with saving after logging in\n{\n  \"files\": {\n    \"lib/supabase.ts\": \"// lib/supbase.ts \\nimport { createClient } from '@supabase/supabase-js'\\n\\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\\n\\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\",\n    \"lib/types.ts\": \"// lib/types.ts\\n\\nexport interface ValuesCard {\\n    id?: string;\\n    created_at?: string;\\n    user_id?: string;\\n    title: string;\\n    description: string;\\n    attention_patterns: string[];\\n    practices: string[];\\n    photo_url?: string;\\n    share_key?: string;\\n    is_public: boolean;\\n    value_promise?: string;\\n    story?: string;\\n  }\\n  // In your types.ts\\nexport interface FriendPerspective {\\n    id?: string;\\n    created_at?: string;\\n    card_id: string;\\n    title: string;\\n    description: string;\\n    attention_patterns: string[];\\n    practices: string[];\\n    story: string;\\n    original_card?: ValuesCard;  // Add this for the join\\n  }\",\n    \"lib/utils.ts\": \"// lib/utils.ts\\nimport { type ClassValue, clsx } from 'clsx';\\nimport { twMerge } from 'tailwind-merge';\\n\\nexport function cn(...inputs: ClassValue[]) {\\n  return twMerge(clsx(inputs));\\n}\",\n    \"lib/prompts.ts\": \"// lib/prompts.ts\\nexport const REFLECTION_PROMPT = `You are a compassionate guide helping people discover their core values through meaningful moments. Your approach:\\n\\n1. Listen deeply to their story and reflect back what seems meaningful\\n2. Ask gentle, probing questions to explore deeper themes\\n3. Notice patterns and metaphors they use\\n4. Help identify what they pay attention to in these meaningful moments\\n\\nApproach:\\n- Use warmth and emotional mirroring\\n- Offer multiple interpretations to help them explore\\n- Build on metaphors they introduce\\n- Move gradually from story to structured insights\\n\\nFormat responses as a natural conversation, but work towards identifying:\\n- What they notice in meaningful moments\\n- What patterns of attention bring them alive\\n- What ways of being feel most authentic\\n\\nEnd goal is to help them articulate a clear values card with:\\n- A title capturing the essence\\n- 3-4 specific things they pay attention to\\n- Always grounded in their actual experience\\n\\nWhen they express clarity about a value, respond with:\\n<values-card>\\n{\\n  \\\"title\\\": \\\"Core value as a simple phrase\\\",\\n  \\\"description\\\": \\\"2-3 sentences connecting their story to this value\\\",\\n  \\\"attention_patterns\\\": [\\\"3-4 specific things they naturally notice or care about\\\"],\\n  \\\"practices\\\": [\\\"2-3 ways to live this value more fully\\\"]\\n}\\n</values-card>\\n\\nOtherwise, continue the natural conversation helping them explore what matters.`;\\n\\nexport const FRIEND_REFLECTION_PROMPT = `You are a compassionate guide helping someone reflect on what they value about a friend. Your approach:\\n\\n1. Listen deeply to their story about their friend and reflect back what seems meaningful\\n2. Ask gentle questions about what they notice in their friend's way of being\\n3. Help them explore the impact their friend has on them\\n4. Notice patterns in how their friend shows up in meaningful moments\\n\\nApproach:\\n- Use warmth and emotional mirroring\\n- Draw out specific stories and examples\\n- Help them articulate what they appreciate\\n- Move gradually from story to deeper insights\\n\\nFormat responses as a natural conversation, but work towards identifying:\\n- What qualities they notice in their friend\\n- What patterns they see in how their friend impacts others\\n- What makes their friend's presence meaningful\\n\\nWhen they express clarity about what they see in their friend, respond with:\\n<values-card>\\n{\\n  \\\"title\\\": \\\"What they bring alive (as a simple phrase)\\\",\\n  \\\"description\\\": \\\"2-3 sentences about their friend's unique way of being\\\",\\n  \\\"attention_patterns\\\": [\\\"3-4 specific things their friend naturally attends to\\\"],\\n  \\\"practices\\\": [\\\"2-3 ways their friend embodies these values\\\"]\\n}\\n</values-card>\\n\\nOtherwise, continue the natural conversation helping them explore their appreciation.`;\",\n    \"app/layout.tsx\": \"// app/layout.tsx\\nimport type { Metadata } from \\\"next\\\";\\nimport { Geist, Geist_Mono } from \\\"next/font/google\\\";\\nimport \\\"./globals.css\\\";\\n\\nconst geistSans = Geist({\\n  variable: \\\"--font-geist-sans\\\",\\n  subsets: [\\\"latin\\\"],\\n});\\n\\nconst geistMono = Geist_Mono({\\n  variable: \\\"--font-geist-mono\\\",\\n  subsets: [\\\"latin\\\"],\\n});\\n\\nexport const metadata: Metadata = {\\n  title: \\\"Values Reflection Tool\\\",\\n  description: \\\"Discover and articulate your values through guided reflection\\\",\\n};\\n\\nexport default function RootLayout({\\n  children,\\n}: Readonly<{\\n  children: React.ReactNode;\\n}>) {\\n  return (\\n    <html lang=\\\"en\\\" suppressHydrationWarning>\\n      <body\\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\\n        suppressHydrationWarning\\n      >\\n        <div id=\\\"app-root\\\">{children}</div>\\n      </body>\\n    </html>\\n  );\\n}\",\n    \"app/page.tsx\": \"// app/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { useRouter } from 'next/navigation';\\nimport { Button } from '@/components/ui/button';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Input } from '@/components/ui/input';\\nimport { supabase } from '@/lib/supabase';\\n\\nexport default function WelcomePage() {\\n  const router = useRouter();\\n  const [user, setUser] = useState<any>(null);\\n  const [email, setEmail] = useState('');\\n  const [isLoading, setIsLoading] = useState(false);\\n  const [message, setMessage] = useState('');\\n\\n  useEffect(() => {\\n    // Check current session\\n    supabase.auth.getSession().then(({ data: { session } }) => {\\n      if (session?.user) {\\n        setUser(session.user);\\n      }\\n    });\\n\\n    // Subscribe to auth state changes\\n    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {\\n      setUser(session?.user || null);\\n    });\\n\\n    return () => subscription.unsubscribe();\\n  }, []);\\n\\n  const handleLogin = async (e: React.FormEvent) => {\\n    e.preventDefault();\\n    setIsLoading(true);\\n    setMessage('');\\n\\n    try {\\n      const { error } = await supabase.auth.signInWithOtp({\\n        email,\\n        options: {\\n          emailRedirectTo: `${window.location.origin}/profile`,\\n        },\\n      });\\n\\n      if (error) throw error;\\n      setMessage('Check your email for the login link!');\\n    } catch (error) {\\n      if (error instanceof Error) {\\n        setMessage(error.message);\\n      } else {\\n        setMessage('An error occurred. Please try again.');\\n      }\\n    } finally {\\n      setIsLoading(false);\\n    }\\n  };\\n\\n  const startReflection = () => {\\n    router.push('/reflection');\\n  };\\n\\n  const goToProfile = () => {\\n    if (!user) {\\n      setMessage('Please sign in to access your profile.');\\n      return;\\n    }\\n    router.push('/profile');\\n  };\\n\\n  const createShareLink = async () => {\\n    if (!user) {\\n      setMessage('You need to sign in to create a share link.');\\n      return;\\n    }\\n\\n    try {\\n      const shareKey = crypto.randomUUID();\\n      const { data, error } = await supabase\\n        .from('values_cards')\\n        .insert([\\n          {\\n            title: 'Value Reflections',\\n            description: 'I\\\\'d like to hear your perspective on what you value about me.',\\n            user_id: user.id,\\n            share_key: shareKey,\\n            is_public: true,\\n          },\\n        ])\\n        .select()\\n        .single();\\n\\n      if (error) throw error;\\n\\n      const shareLink = `${window.location.origin}/friend/${shareKey}`;\\n      await navigator.clipboard.writeText(shareLink);\\n      setMessage('Share link copied to clipboard!');\\n    } catch (err) {\\n      console.error('Error creating share link:', err);\\n      setMessage('Failed to create share link. Please try again.');\\n    }\\n  };\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-gray-50 py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        <Card className=\\\"bg-white shadow-lg rounded-lg\\\">\\n          <CardHeader className=\\\"p-6 border-b border-gray-200\\\">\\n            <h1 className=\\\"text-3xl font-bold text-gray-800 text-center\\\">\\n              Welcome to Values Reflection\\n            </h1>\\n          </CardHeader>\\n          <CardContent className=\\\"p-6\\\">\\n            <div className=\\\"text-center space-y-8\\\">\\n              <p className=\\\"text-gray-600 text-lg\\\">\\n                Start reflecting on your values and insights, you can log in now to save your reflections, or reflect and create a link to save without a profile.\\n              </p>\\n              <div className=\\\"space-y-4\\\">\\n                <Button\\n                  onClick={startReflection}\\n                  className=\\\"w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg shadow-md\\\"\\n                >\\n                  Reflect Now\\n                </Button>\\n                {user ? (\\n                  <>\\n                    <div className=\\\"bg-blue-50 p-4 rounded-lg\\\">\\n                      <p className=\\\"text-blue-800\\\">\\n                        Welcome back, {user.email}!\\n                      </p>\\n                    </div>\\n                    <Button\\n                      onClick={goToProfile}\\n                      className=\\\"w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg shadow-md\\\"\\n                    >\\n                      View Your Profile\\n                    </Button>\\n                    <Button\\n                      onClick={createShareLink}\\n                      className=\\\"w-full bg-purple-500 hover:bg-purple-600 text-white py-3 rounded-lg shadow-md\\\"\\n                    >\\n                      Create Share Link\\n                    </Button>\\n                  </>\\n                ) : (\\n                  <form onSubmit={handleLogin} className=\\\"space-y-4\\\">\\n                    <Input\\n                      type=\\\"email\\\"\\n                      placeholder=\\\"Enter your email\\\"\\n                      value={email}\\n                      onChange={(e) => setEmail(e.target.value)}\\n                      required\\n                      className=\\\"w-full px-4 py-2 text-gray-900 bg-gray-100 border border-gray-300 rounded-lg\\\"\\n                    />\\n                    <Button\\n                      type=\\\"submit\\\"\\n                      className=\\\"w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg shadow-md\\\"\\n                      disabled={isLoading}\\n                    >\\n                      {isLoading ? 'Sending...' : 'Send email to login/sign-sp here'}\\n                    </Button>\\n                  </form>\\n                )}\\n                {message && (\\n                  <p\\n                    className={`text-sm mt-2 ${\\n                      message.includes('Check your email') || message.includes('Share link copied')\\n                        ? 'text-green-600'\\n                        : 'text-red-600'\\n                    }`}\\n                  >\\n                    {message}\\n                  </p>\\n                )}\\n              </div>\\n            </div>\\n          </CardContent>\\n        </Card>\\n      </div>\\n    </div>\\n  );\\n}\\n\",\n    \"app/reflection/page.tsx\": \"'use client';\\n\\nimport { useState } from 'react';\\nimport { useReflection } from '@/contexts/ReflectionContext';\\nimport { supabase } from '@/lib/supabase';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { ChatUI } from '@/components/reflection/shared/ChatUI';\\nimport ValuesCard from '@/components/reflection/ValuesCard';\\nimport { ValuesCard as ValuesCardType } from '@/lib/types';\\nimport { REFLECTION_PROMPT } from '@/lib/prompts';\\n\\nexport default function ReflectionPage() {\\n  const { state, updateState } = useReflection();\\n  const [story, setStory] = useState('');\\n  const [photoFile, setPhotoFile] = useState<File | null>(null);\\n  const [showChat, setShowChat] = useState(false);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  // Track save state to prevent quick double-saves\\n  const [isSaving, setIsSaving] = useState(false);\\n\\n  /**\\n   * Handle the user clicking \\\"Continue\\\" after entering a story (and optional photo).\\n   */\\n  const handleStorySubmit = async () => {\\n    if (!story.trim() || isSubmitting) return;\\n\\n    setIsSubmitting(true);\\n    try {\\n      let photo_url = '';\\n      if (photoFile) {\\n        const { data, error } = await supabase.storage\\n          .from('values-photos')\\n          .upload(`public/${Date.now()}-${photoFile.name}`, photoFile);\\n\\n        if (!error && data) {\\n          const { data: urlData } = supabase.storage\\n            .from('values-photos')\\n            .getPublicUrl(data.path);\\n          photo_url = urlData.publicUrl;\\n        }\\n      }\\n\\n      // Store story + photo in context for later use\\n      updateState({ story, photo_url });\\n      setShowChat(true);\\n    } catch (error) {\\n      console.error('Error uploading photo:', error);\\n      alert('Failed to upload photo. Please try again.');\\n    } finally {\\n      setIsSubmitting(false);\\n    }\\n  };\\n\\n  /**\\n   * Called by <ChatUI> once the user has sufficiently detailed their values card.\\n   * We'll see if we already have a row in \\\"values_cards\\\" with this session_id.\\n   * If yes, we update it. If no, we insert a new row. \\n   */\\n  const handleChatComplete = async (valuesCard: any) => {\\n    if (isSaving) {\\n      console.log('Skipping duplicate save...');\\n      return;\\n    }\\n    setIsSaving(true);\\n  \\n    try {\\n      const { title, description, attention_patterns, practices } = valuesCard;\\n      const updates = {\\n        title: title || 'Untitled Card',\\n        description: description || '',\\n        attention_patterns: attention_patterns || [],\\n        practices: practices || [],\\n        story: state.story || '',\\n        photo_url: state.photo_url || null,\\n        is_public: false,\\n        session_id: state.session_id,\\n      };\\n  \\n      // Use upsert instead of separate insert/update logic\\n      const { data, error } = await supabase\\n        .from('values_cards')\\n        .upsert(updates, {\\n          onConflict: 'session_id',\\n          ignoreDuplicates: false\\n        })\\n        .select('*')\\n        .single();\\n  \\n      if (error) {\\n        console.error('Error saving card:', error);\\n        throw error;\\n      }\\n  \\n      if (!data) {\\n        throw new Error('No data returned from upsert operation');\\n      }\\n  \\n      console.log('Card saved successfully:', data);\\n      updateState({ values_card: data });\\n    } catch (err) {\\n      console.error('Error saving card:', err);\\n      alert('An error occurred while saving your values card. Please try again.');\\n    } finally {\\n      setIsSaving(false);\\n    }\\n  };\\n  \\n  /**\\n   * Called by <ValuesCard> if the user changes their card details\\n   * (like toggling public or editing the promise).\\n   */\\n  const handleUpdateCard = async (updates: Partial<ValuesCardType>) => {\\n    if (!state.session_id && !state.values_card?.id) return false;\\n  \\n    try {\\n      // Start a retry loop for concurrent updates\\n      let retries = 3;\\n      while (retries > 0) {\\n        const { data, error, count } = await supabase\\n          .from('values_cards')\\n          .update(updates)\\n          .match(state.session_id \\n            ? { session_id: state.session_id }\\n            : { id: state.values_card?.id })\\n          .select('*')\\n          .single();\\n  \\n        if (error) {\\n          if (error.code === '23505' && retries > 1) {\\n            // Concurrent update, wait and retry\\n            await new Promise(resolve => setTimeout(resolve, 1000));\\n            retries--;\\n            continue;\\n          }\\n          throw error;\\n        }\\n  \\n        if (!data) {\\n          throw new Error('No rows updated. The card might not exist.');\\n        }\\n  \\n        // Update was successful\\n        updateState({\\n          values_card: { ...state.values_card, ...data } as ValuesCardType,\\n        });\\n        return true;\\n      }\\n      \\n      throw new Error('Failed to update after retries');\\n    } catch (err) {\\n      console.error('Error updating card:', err);\\n      alert('Failed to save your changes. Please try again.');\\n      return false;\\n    }\\n  };\\n    /**\\n   * Called by <ValuesCard> to save a generated share link\\n   */\\n  const handleShare = (shareKey: string) => {\\n    updateState({ share_key: shareKey });\\n  };\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        {showChat || state.values_card ? (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Explore Your Values\\n              </h1>\\n            </header>\\n            <main className=\\\"p-cardPadding\\\">\\n              {/* If we haven’t saved a card yet, show the ChatUI */}\\n              {showChat && !state.values_card && (\\n                <Card>\\n                  <CardHeader>\\n                    <h1 className=\\\"text-2xl font-bold text-gray-900\\\">\\n                      Continue Your Story\\n                    </h1>\\n                  </CardHeader>\\n                  <CardContent>\\n                  <ChatUI\\n  onComplete={handleChatComplete}\\n  className=\\\"min-h-[400px]\\\"\\n  initialMessage={`Thank you for sharing this story. Let's explore what makes it meaningful and the values it highlights. What stands out most to you about this experience?`}\\n  systemPrompt={REFLECTION_PROMPT}\\n/>\\n                  </CardContent>\\n                </Card>\\n              )}\\n\\n              {/* If we have a card, show the ValuesCard component */}\\n              {state.values_card && (\\n                <ValuesCard\\n                  {...state.values_card}\\n                  photo_url={state.photo_url}\\n                  onShare={handleShare}\\n                  onUpdate={handleUpdateCard}\\n                />\\n              )}\\n            </main>\\n          </div>\\n        ) : (\\n          // The initial form for story submission\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Share a Meaningful Story\\n              </h1>\\n            </header>\\n            <main className=\\\"p-cardPadding space-y-6\\\">\\n              <textarea\\n                value={story}\\n                onChange={(e) => setStory(e.target.value)}\\n                placeholder=\\\"Tell me about a meaningful experience...\\\"\\n                className=\\\"w-full p-4 rounded-lg border border-gray-300 bg-white text-black placeholder-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none min-h-[200px]\\\"\\n              />\\n              <div>\\n                <label className=\\\"block text-sm text-gray-700 mb-2\\\">\\n                  Add a photo (optional)\\n                </label>\\n                <input\\n                  type=\\\"file\\\"\\n                  accept=\\\"image/*\\\"\\n                  onChange={(e) =>\\n                    setPhotoFile(e.target.files?.[0] || null)\\n                  }\\n                  className=\\\"text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100\\\"\\n                />\\n              </div>\\n              <button\\n                onClick={handleStorySubmit}\\n                disabled={!story.trim() || isSubmitting}\\n                className={`w-full py-2 rounded-lg font-medium transition-colors ${\\n                  story.trim() && !isSubmitting\\n                    ? 'bg-blue-500 text-white hover:bg-blue-600'\\n                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'\\n                }`}\\n              >\\n                {isSubmitting ? 'Submitting...' : 'Continue'}\\n              </button>\\n            </main>\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\",\n    \"app/profile/page.tsx\": \"'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { supabase } from '@/lib/supabase';\\nimport Link from 'next/link';\\nimport type { ValuesCard as ValuesCardType, FriendPerspective } from '@/lib/types';\\n\\nexport default function ProfilePage() {\\n  const [user, setUser] = useState<any>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [myValues, setMyValues] = useState<ValuesCardType[]>([]);\\n  const [friendPerspectives, setFriendPerspectives] = useState<FriendPerspective[]>([]);\\n\\n  useEffect(() => {\\n    supabase.auth.getSession().then(({ data: { session } }) => {\\n      if (!session) {\\n        window.location.href = '/';\\n        return;\\n      }\\n      setUser(session.user);\\n      loadContent(session.user.id);\\n    });\\n\\n    return () => {\\n      supabase.auth.onAuthStateChange((_event, session) => {\\n        if (!session) {\\n          window.location.href = '/';\\n          return;\\n        }\\n        setUser(session.user);\\n        loadContent(session.user.id);\\n      });\\n    };\\n  }, []);\\n\\n  const loadContent = async (userId: string) => {\\n    try {\\n      const { data: valuesCards, error: valuesError } = await supabase\\n        .from('values_cards')\\n        .select('*')\\n        .eq('user_id', userId)\\n        .order('created_at', { ascending: false });\\n\\n      if (valuesError) throw valuesError;\\n\\n      setMyValues(valuesCards || []);\\n\\n      const { data: perspectives, error: perspectivesError } = await supabase\\n        .from('friend_perspectives')\\n        .select('*')\\n        .order('created_at', { ascending: false });\\n\\n      if (perspectivesError) throw perspectivesError;\\n\\n      setFriendPerspectives(perspectives || []);\\n    } catch (error) {\\n      console.error('Error loading content:', error);\\n    } finally {\\n      setLoading(false);\\n    }\\n  };\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12 flex items-center justify-center\\\">\\n        <div className=\\\"animate-pulse text-gray-500\\\">Loading...</div>\\n      </div>\\n    );\\n  }\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-6\\\">\\n      {/* Header */}\\n      <header className=\\\"bg-gray-100 py-4 shadow-md\\\">\\n        <div className=\\\"max-w-6xl mx-auto px-4 flex justify-between items-center\\\">\\n          <h1 className=\\\"text-xl font-bold text-gray-900\\\">My Profile</h1>\\n          <div className=\\\"space-x-4\\\">\\n            <Link href=\\\"/\\\">\\n              <button className=\\\"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition\\\">\\n                Home\\n              </button>\\n            </Link>\\n            <Link href=\\\"/reflection\\\">\\n              <button className=\\\"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition\\\">\\n                Reflect\\n              </button>\\n            </Link>\\n            <button\\n              onClick={async () => {\\n                await supabase.auth.signOut();\\n                window.location.href = '/';\\n              }}\\n              className=\\\"bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition\\\"\\n            >\\n              Logout\\n            </button>\\n          </div>\\n        </div>\\n      </header>\\n\\n      {/* Main Content */}\\n      <div className=\\\"max-w-6xl mx-auto px-4 py-8 space-y-12\\\">\\n        {/* My Reflections */}\\n        <section>\\n          <h2 className=\\\"text-3xl font-bold text-gray-900 mb-6\\\">My Values Reflections</h2>\\n          <div className=\\\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\\\">\\n            {myValues.map((card) => (\\n              <Link key={card.id} href={`/card/${card.session_id}`}>\\n                <Card className=\\\"hover:shadow-lg transition-shadow cursor-pointer h-full\\\">\\n                  <CardHeader>\\n                    <h3 className=\\\"text-xl font-semibold\\\">{card.title}</h3>\\n                  </CardHeader>\\n                  <CardContent>\\n                    <p className=\\\"text-gray-600 line-clamp-3\\\">{card.description}</p>\\n                    {card.photo_url && (\\n                      <div className=\\\"mt-4 aspect-video relative overflow-hidden rounded\\\">\\n                        <img\\n                          src={card.photo_url}\\n                          alt=\\\"Reflection moment\\\"\\n                          className=\\\"object-cover w-full h-full\\\"\\n                        />\\n                      </div>\\n                    )}\\n                  </CardContent>\\n                </Card>\\n              </Link>\\n            ))}\\n          </div>\\n        </section>\\n\\n        {/* Friend Perspectives */}\\n        <section>\\n          <h2 className=\\\"text-3xl font-bold text-gray-900 mb-6\\\">\\n            What Your Friends Appreciate About You\\n          </h2>\\n          <div className=\\\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\\\">\\n            {friendPerspectives.map((perspective) => (\\n              <Link key={perspective.id} href={`/perspective/${perspective.id}`}>\\n                <Card className=\\\"hover:shadow-lg transition-shadow cursor-pointer h-full\\\">\\n                  <CardHeader>\\n                    <h3 className=\\\"text-xl font-semibold\\\">{perspective.title}</h3>\\n                  </CardHeader>\\n                  <CardContent>\\n                    <p className=\\\"text-gray-600 line-clamp-3\\\">{perspective.description}</p>\\n                  </CardContent>\\n                </Card>\\n              </Link>\\n            ))}\\n          </div>\\n        </section>\\n\\n        {/* Empty State */}\\n        {!myValues.length && !friendPerspectives.length && (\\n          <div className=\\\"text-center py-12\\\">\\n            <h3 className=\\\"text-xl font-semibold text-gray-700 mb-4\\\">\\n              No reflections or perspectives yet.\\n            </h3>\\n            <Link href=\\\"/reflection\\\" className=\\\"text-blue-600 hover:text-blue-800 underline\\\">\\n              Start your first reflection\\n            </Link>\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\\n\",\n    \"app/api/reflection/chat/route.ts\": \"// app/api/reflection/chat/route.ts\\n// app/api/reflection/chat/route.ts\\nimport OpenAI from 'openai';\\nimport { NextResponse } from 'next/server';\\n\\nconst openai = new OpenAI({\\n  apiKey: process.env.OPENAI_API_KEY!,\\n});\\n\\nconst systemPrompt = `You are a compassionate guide helping people discover their core values through meaningful moments. Your approach:\\n\\n1. Listen deeply to their story and reflect back what seems meaningful\\n2. Ask gentle, probing questions to explore deeper themes\\n3. Notice patterns and metaphors they use\\n4. Help identify what they pay attention to in these meaningful moments\\n\\nApproach:\\n- Use warmth and emotional mirroring\\n- Offer multiple interpretations to help them explore\\n- Build on metaphors they introduce\\n- Move gradually from story to structured insights\\n\\nFormat responses as a natural conversation, but work towards identifying:\\n- What they notice in meaningful moments\\n- What patterns of attention bring them alive\\n- What ways of being feel most authentic\\n\\nEnd goal is to help them articulate a clear values card with:\\n- A title capturing the essence\\n- 3-4 specific things they pay attention to\\n- Always grounded in their actual experience\\n\\nWhen they express clarity about a value, respond with:\\n<values-card>\\n{\\n  \\\"title\\\": \\\"Core value as a simple phrase\\\",\\n  \\\"description\\\": \\\"2-3 sentences connecting their story to this value\\\",\\n  \\\"attention_patterns\\\": [\\\"3-4 specific things they naturally notice or care about\\\"],\\n  \\\"practices\\\": [\\\"2-3 ways to live this value more fully\\\"]\\n}\\n</values-card>\\n\\nOtherwise, continue the natural conversation helping them explore what matters.`;\\n\\nexport async function POST(req: Request) {\\n  try {\\n    const { messages } = await req.json();\\n\\n    const completion = await openai.chat.completions.create({\\n      model: 'gpt-4-turbo',\\n      stream: true,\\n      messages: [\\n        { role: 'system', content: systemPrompt },\\n        ...messages,\\n      ],\\n    });\\n\\n    // Create a readable stream\\n    const stream = new ReadableStream({\\n      async start(controller) {\\n        try {\\n          for await (const chunk of completion) {\\n            const content = chunk.choices[0]?.delta?.content || '';\\n            if (content) {\\n              controller.enqueue(new TextEncoder().encode(content));\\n            }\\n          }\\n        } catch (err) {\\n          console.error('Error streaming response:', err);\\n          controller.error(err);\\n        } finally {\\n          controller.close();\\n        }\\n      },\\n    });\\n\\n    return new Response(stream, {\\n      headers: {\\n        'Content-Type': 'text/plain; charset=utf-8',\\n        'Cache-Control': 'no-cache',\\n      },\\n    });\\n  } catch (error) {\\n    console.error('Error in API route:', error);\\n    return NextResponse.json({ error: 'Failed to process the request' }, { status: 500 });\\n  }\\n}\",\n    \"components/reflection/ValuesCard.tsx\": \"'use client';\\n\\nimport { useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport type { ValuesCard as ValuesCardType } from '@/lib/types';\\n\\ninterface ValuesCardProps extends Partial<ValuesCardType> {\\n  onShare?: (shareKey: string) => void;\\n  onUpdate?: (updates: Partial<ValuesCardType>) => Promise<boolean>;\\n}\\n\\nexport default function ValuesCard({\\n  id,\\n  title,\\n  description,\\n  attention_patterns = [],\\n  practices = [],\\n  photo_url,\\n  share_key: initialShareKey,\\n  value_promise: initialValuePromise,\\n  onShare,\\n  onUpdate,\\n}: ValuesCardProps) {\\n  const [isSharing, setIsSharing] = useState(false);\\n  const [shareKey, setShareKey] = useState<string | null>(initialShareKey || null);\\n  const [valuePromise, setValuePromise] = useState(initialValuePromise || '');\\n  const [isEditingPromise, setIsEditingPromise] = useState(!initialValuePromise);\\n  const [isSavingPromise, setIsSavingPromise] = useState(false);\\n  const [isImageModalOpen, setIsImageModalOpen] = useState(false);\\n\\n  const handleShare = async () => {\\n    if (!id || !onUpdate || !onShare) return;\\n\\n    setIsSharing(true);\\n    try {\\n      const newShareKey = crypto.randomUUID();\\n      const success = await onUpdate({ \\n        share_key: newShareKey,\\n        is_public: true \\n      });\\n      \\n      if (success) {\\n        setShareKey(newShareKey);\\n        onShare(newShareKey);\\n      }\\n    } catch (err) {\\n      console.error('Error sharing card:', err);\\n      alert('Sorry, there was an error sharing your card. Please try again.');\\n    } finally {\\n      setIsSharing(false);\\n    }\\n  };\\n\\n  const saveValuePromise = async () => {\\n    if (!id || !onUpdate) return;\\n\\n    setIsSavingPromise(true);\\n    try {\\n      const success = await onUpdate({ value_promise: valuePromise });\\n      if (success) {\\n        setIsEditingPromise(false);\\n      }\\n    } catch (err) {\\n      console.error('Error saving promise:', err);\\n      alert('Sorry, there was an error saving your promise. Please try again.');\\n    } finally {\\n      setIsSavingPromise(false);\\n    }\\n  };\\n\\n  return (\\n    <Card className=\\\"w-full bg-white shadow-lg\\\">\\n      <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n        <h2 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{title}</h2>\\n      </CardHeader>\\n      <CardContent className=\\\"space-y-6 p-8\\\">\\n        {/* Image Section */}\\n        {photo_url && (\\n          <div \\n            onClick={() => setIsImageModalOpen(true)}\\n            className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n          >\\n            <img\\n              src={photo_url}\\n              alt=\\\"Meaningful moment\\\"\\n              className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n            />\\n          </div>\\n        )}\\n\\n        <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{description}</p>\\n\\n        {/* Attention Patterns Section */}\\n        <div className=\\\"space-y-3\\\">\\n          <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What you pay attention to:</h3>\\n          <ul className=\\\"space-y-2\\\">\\n            {attention_patterns.map((pattern, i) => (\\n              <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                {pattern}\\n              </li>\\n            ))}\\n          </ul>\\n        </div>\\n\\n        {/* Practices Section */}\\n        <div className=\\\"space-y-3\\\">\\n          <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Ways to live this value:</h3>\\n          <ul className=\\\"space-y-2\\\">\\n            {practices.map((practice, i) => (\\n              <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                {practice}\\n              </li>\\n            ))}\\n          </ul>\\n        </div>\\n\\n        {/* Value Promise Section */}\\n        <div className=\\\"space-y-3 border-t pt-6\\\">\\n          <div className=\\\"flex justify-between items-center\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Your Value Promise</h3>\\n            {!isEditingPromise && (\\n              <Button\\n                onClick={() => setIsEditingPromise(true)}\\n                variant=\\\"outline\\\"\\n                size=\\\"sm\\\"\\n              >\\n                Edit Promise\\n              </Button>\\n            )}\\n          </div>\\n\\n          {isEditingPromise ? (\\n            <div className=\\\"space-y-3\\\">\\n              <Textarea\\n                value={valuePromise}\\n                onChange={(e) => setValuePromise(e.target.value)}\\n                placeholder=\\\"How will you bring this value to life in the coming year?\\\"\\n                className=\\\"min-h-[100px]\\\"\\n              />\\n              <div className=\\\"flex gap-2\\\">\\n                <Button\\n                  onClick={saveValuePromise}\\n                  disabled={isSavingPromise}\\n                  className=\\\"flex-1 bg-blue-600 hover:bg-blue-700 text-white\\\"\\n                >\\n                  {isSavingPromise ? 'Saving...' : 'Save Promise'}\\n                </Button>\\n                <Button\\n                  onClick={() => {\\n                    setIsEditingPromise(false);\\n                    setValuePromise(initialValuePromise || '');\\n                  }}\\n                  variant=\\\"outline\\\"\\n                  className=\\\"flex-1\\\"\\n                  disabled={isSavingPromise}\\n                >\\n                  Cancel\\n                </Button>\\n              </div>\\n            </div>\\n          ) : (\\n            <div className=\\\"bg-gray-50 p-4 rounded\\\">\\n              <p className=\\\"text-gray-700\\\">\\n                {valuePromise || \\\"Click 'Edit Promise' to add your commitment to living this value.\\\"}\\n              </p>\\n            </div>\\n          )}\\n        </div>\\n\\n{/* Share Section */}\\n<div className=\\\"space-y-4 border-t pt-6\\\">\\n  <div className=\\\"flex items-center justify-between\\\">\\n    <h3 className=\\\"font-semibold text-gray-900\\\">Share Your Values Card</h3>\\n    {!shareKey && (\\n      <Button\\n        onClick={handleShare}\\n        disabled={isSharing}\\n        className=\\\"bg-blue-600 hover:bg-blue-700 text-white\\\"\\n      >\\n        {isSharing ? 'Creating Link...' : 'Create Share Link'}\\n      </Button>\\n    )}\\n  </div>\\n\\n  {shareKey && (\\n    <div className=\\\"bg-gray-50 p-4 rounded-lg space-y-4\\\">\\n      {/* Link to view the values card */}\\n      <div>\\n        <p className=\\\"text-sm text-gray-800 font-medium mb-2\\\">\\n          Share this link to view your values card:\\n        </p>\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <a\\n            href={`${window.location.origin}/card/${shareKey}`}\\n            target=\\\"_blank\\\"\\n            rel=\\\"noopener noreferrer\\\"\\n            className=\\\"text-gray-900 underline break-all\\\"\\n          >\\n            {`${window.location.origin}/card/${shareKey}`}\\n          </a>\\n          <Button\\n            onClick={() =>\\n              navigator.clipboard.writeText(\\n                `${window.location.origin}/card/${shareKey}`\\n              ).then(() => alert('Link copied!'))\\n            }\\n            variant=\\\"outline\\\"\\n            size=\\\"sm\\\"\\n          >\\n            Copy\\n          </Button>\\n        </div>\\n      </div>\\n\\n      {/* Link to get friends' perspectives */}\\n      <div>\\n        <p className=\\\"text-sm text-gray-800 font-medium mb-2\\\">\\n          Share this link to get friends' perspectives:\\n        </p>\\n        <div className=\\\"flex items-center gap-2\\\">\\n          <a\\n            href={`${window.location.origin}/friend/${shareKey}`}\\n            target=\\\"_blank\\\"\\n            rel=\\\"noopener noreferrer\\\"\\n            className=\\\"text-gray-900 underline break-all\\\"\\n          >\\n            {`${window.location.origin}/friend/${shareKey}`}\\n          </a>\\n          <Button\\n            onClick={() =>\\n              navigator.clipboard.writeText(\\n                `${window.location.origin}/friend/${shareKey}`\\n              ).then(() => alert('Link copied!'))\\n            }\\n            variant=\\\"outline\\\"\\n            size=\\\"sm\\\"\\n          >\\n            Copy\\n          </Button>\\n        </div>\\n      </div>\\n    </div>\\n  )}\\n</div>\\n      </CardContent>\\n    </Card>\\n  );\\n}\",\n    \"components/reflection/FriendValuesCard.tsx\": \"// components/reflection/FriendValuesCard.tsx\\n'use client';\\n\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport type { FriendPerspective } from '@/lib/types';\\n\\ninterface FriendValuesCardProps extends Partial<FriendPerspective> {}\\n\\nexport default function FriendValuesCard({\\n  title,\\n  description,\\n  attention_patterns = [],\\n  practices = [],\\n  photo_url,\\n  story,\\n}: FriendValuesCardProps) {\\n  return (\\n    <Card className=\\\"w-full bg-white shadow-lg\\\">\\n      <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n        <h2 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{title}</h2>\\n      </CardHeader>\\n      <CardContent className=\\\"space-y-6 p-8\\\">\\n        {photo_url && (\\n          <div className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner\\\">\\n            <img\\n              src={photo_url}\\n              alt=\\\"Meaningful moment\\\"\\n              className=\\\"object-cover w-full h-full\\\"\\n            />\\n          </div>\\n        )}\\n\\n        <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{description}</p>\\n\\n        {/* Story Section */}\\n        {story && (\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">The Memory</h3>\\n            <div className=\\\"bg-gray-50 p-4 rounded-lg\\\">\\n              <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{story}</p>\\n            </div>\\n          </div>\\n        )}\\n\\n        {/* What They Notice Section */}\\n        {attention_patterns.length > 0 && (\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What They Notice</h3>\\n            <ul className=\\\"space-y-2\\\">\\n              {attention_patterns.map((pattern, i) => (\\n                <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                  <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                  {pattern}\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n        )}\\n\\n        {/* Their Impact Section */}\\n        {practices.length > 0 && (\\n          <div className=\\\"space-y-3\\\">\\n            <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Their Impact</h3>\\n            <ul className=\\\"space-y-2\\\">\\n              {practices.map((practice, i) => (\\n                <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                  <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                  {practice}\\n                </li>\\n              ))}\\n            </ul>\\n          </div>\\n        )}\\n      </CardContent>\\n    </Card>\\n  );\\n}\",\n    \"components/reflection/shared/ChatUI.tsx\": \"'use client';\\n\\nimport { useRef, useState, useEffect } from 'react';\\nimport { Button } from '@/components/ui/button';\\nimport { Textarea } from '@/components/ui/textarea';\\nimport { Send } from 'lucide-react';\\nimport { cn } from '@/lib/utils';\\n\\ninterface ChatUIProps {\\n  onComplete?: (valuesCard: any) => void;\\n  className?: string;\\n  initialMessage?: string;\\n  systemPrompt?: string;\\n}\\n\\nexport function ChatUI({ onComplete, className, initialMessage, systemPrompt }: ChatUIProps) {\\n  const [messages, setMessages] = useState(\\n    initialMessage ? [{ role: 'assistant', content: initialMessage }] : []\\n  );\\n  const [input, setInput] = useState('');\\n  const [isThinking, setIsThinking] = useState(false);\\n  const [hasCardBeenParsed, setHasCardBeenParsed] = useState(false);\\n  const chatEndRef = useRef<HTMLDivElement | null>(null);\\n\\n  useEffect(() => {\\n    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });\\n  }, [messages]);\\n\\n  const handleMessage = (text: string) => {\\n    if (hasCardBeenParsed) return text;\\n\\n    const cardMatch = text.match(/<values-card>(.*?)<\\\\/values-card>/s);\\n    if (cardMatch) {\\n      try {\\n        const valuesCard = JSON.parse(cardMatch[1]);\\n        onComplete?.(valuesCard);\\n        setHasCardBeenParsed(true);\\n        return \\\"I've captured your reflection. Thank you for sharing your perspective.\\\";\\n      } catch (error) {\\n        console.error('Error parsing values card:', error);\\n      }\\n    }\\n    return text;\\n  };\\n\\n  const handleSendMessage = async () => {\\n    if (!input.trim()) return;\\n\\n    const userMessage = { role: 'user', content: input.trim() };\\n    setMessages(prev => [...prev, userMessage]);\\n    setInput('');\\n    setIsThinking(true);\\n\\n    try {\\n      const response = await fetch('/api/reflection/chat', {\\n        method: 'POST',\\n        headers: { 'Content-Type': 'application/json' },\\n        body: JSON.stringify({\\n          messages: [...messages, userMessage],\\n          systemPrompt: systemPrompt // Pass the systemPrompt to the API\\n        }),\\n      });\\n\\n      if (!response.body) return;\\n\\n      const reader = response.body.getReader();\\n      const decoder = new TextDecoder();\\n      let assistantMessage = '';\\n\\n      while (true) {\\n        const { done, value } = await reader.read();\\n        if (done) break;\\n\\n        const chunk = decoder.decode(value, { stream: true });\\n        assistantMessage += chunk;\\n\\n        const displayMessage = handleMessage(assistantMessage);\\n\\n        setMessages(prev => {\\n          const updated = [...prev];\\n          const lastMessage = updated[updated.length - 1];\\n          if (lastMessage.role === 'assistant') {\\n            lastMessage.content = displayMessage;\\n          } else {\\n            updated.push({ role: 'assistant', content: displayMessage });\\n          }\\n          return updated;\\n        });\\n      }\\n    } catch (err) {\\n      console.error('Error:', err);\\n      setMessages(prev => [\\n        ...prev,\\n        {\\n          role: 'assistant',\\n          content: \\\"I'm sorry, I encountered an error. Please try again.\\\"\\n        }\\n      ]);\\n    } finally {\\n      setIsThinking(false);\\n    }\\n  };\\n\\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\\n    if (e.key === 'Enter' && !e.shiftKey) {\\n      e.preventDefault();\\n      handleSendMessage();\\n    }\\n  };\\n\\n  return (\\n    <div className={cn('flex flex-col space-y-4', className)}>\\n      <div className=\\\"flex-1 overflow-y-auto space-y-4 min-h-[300px] max-h-[500px] p-4 rounded-lg bg-white\\\">\\n        {messages.map((message, index) => (\\n          <div\\n            key={index}\\n            className={cn(\\n              'flex w-full',\\n              message.role === 'user' ? 'justify-end' : 'justify-start'\\n            )}\\n          >\\n            <div\\n              className={cn(\\n                'rounded-lg px-4 py-2 max-w-[80%]',\\n                message.role === 'user'\\n                  ? 'bg-blue-500 text-white'\\n                  : 'bg-gray-100 text-gray-900'\\n              )}\\n            >\\n              {message.content}\\n            </div>\\n          </div>\\n        ))}\\n        <div ref={chatEndRef} />\\n      </div>\\n\\n      <form\\n        onSubmit={(e) => {\\n          e.preventDefault();\\n          handleSendMessage();\\n        }}\\n        className=\\\"flex items-end gap-2\\\"\\n      >\\n        <Textarea\\n          value={input}\\n          onChange={(e) => setInput(e.target.value)}\\n          onKeyDown={handleKeyDown}\\n          placeholder=\\\"Share your thoughts...\\\"\\n          className=\\\"flex-1 min-h-[80px] p-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500\\\"\\n          disabled={isThinking}\\n        />\\n        <Button\\n          type=\\\"submit\\\"\\n          className=\\\"flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg\\\"\\n          disabled={isThinking || !input.trim()}\\n        >\\n          <Send className=\\\"w-4 h-4\\\" />\\n          {isThinking ? 'Thinking...' : 'Send'}\\n        </Button>\\n      </form>\\n    </div>\\n  );\\n}\",\n    \"components/ui/button.tsx\": \"// components/ui/button.tsx\\nimport * as React from 'react'\\nimport { cn } from '@/lib/utils'\\n\\nexport interface ButtonProps\\n  extends React.ButtonHTMLAttributes<HTMLButtonElement> {\\n  variant?: 'default' | 'destructive' | 'outline' | 'secondary' | 'ghost' | 'link'\\n  size?: 'default' | 'sm' | 'lg'\\n}\\n\\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\\n  ({ className, variant = 'default', size = 'default', ...props }, ref) => {\\n    return (\\n      <button\\n        className={cn(\\n        'inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',\\n          {\\n            'bg-blue-500 text-white hover:bg-blue-600': variant === 'default',\\n            // Adjust outline for better contrast\\n            'border border-gray-300 bg-gray-50 text-gray-900 hover:bg-gray-100': variant === 'outline',\\n\\n            'bg-secondary text-secondary-foreground hover:bg-secondary/80': variant === 'secondary',\\n            'hover:bg-accent hover:text-accent-foreground': variant === 'ghost',\\n            'text-primary underline-offset-4 hover:underline': variant === 'link',\\n          },\\n          {\\n            'h-10 px-4 py-2': size === 'default',\\n            'h-9 rounded-md px-3': size === 'sm',\\n            'h-11 rounded-md px-8': size === 'lg',\\n          },\\n          className\\n        )}\\n        ref={ref}\\n        {...props}\\n      />\\n    )\\n  }\\n)\\nButton.displayName = 'Button'\\n\\nexport { Button }\",\n    \"components/ui/card.tsx\": \"// components/ui/card.tsx\\nimport * as React from 'react'\\nimport { cn } from '@/lib/utils'\\n\\nconst Card = React.forwardRef<\\n  HTMLDivElement,\\n  React.HTMLAttributes<HTMLDivElement>\\n>(({ className, ...props }, ref) => (\\n  <div\\n    ref={ref}\\n    className={cn(\\n      'rounded-lg border bg-card text-card-foreground shadow-sm',\\n      className\\n    )}\\n    {...props}\\n  />\\n))\\nCard.displayName = 'Card'\\n\\nconst CardHeader = React.forwardRef<\\n  HTMLDivElement,\\n  React.HTMLAttributes<HTMLDivElement>\\n>(({ className, ...props }, ref) => (\\n  <div\\n    ref={ref}\\n    className={cn('flex flex-col space-y-1.5 p-6', className)}\\n    {...props}\\n  />\\n))\\nCardHeader.displayName = 'CardHeader'\\n\\nconst CardContent = React.forwardRef<\\n  HTMLDivElement,\\n  React.HTMLAttributes<HTMLDivElement>\\n>(({ className, ...props }, ref) => (\\n  <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />\\n))\\nCardContent.displayName = 'CardContent'\\n\\nexport { Card, CardHeader, CardContent }\\n\",\n    \"components/ui/input.tsx\": \"// components/ui/input.tsx\\nimport * as React from \\\"react\\\"\\nimport { cn } from \\\"@/lib/utils\\\"\\n\\nexport interface InputProps\\n  extends React.InputHTMLAttributes<HTMLInputElement> {}\\n\\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\\n  ({ className, type, ...props }, ref) => {\\n    return (\\n      <input\\n        type={type}\\n        className={cn(\\n          \\\"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\\\",\\n          className\\n        )}\\n        ref={ref}\\n        {...props}\\n      />\\n    )\\n  }\\n)\\nInput.displayName = \\\"Input\\\"\\n\\nexport { Input }\",\n    \"components/ui/textarea.tsx\": \"// components/ui/textarea.tsx\\nimport * as React from 'react';\\nimport { cn } from '@/lib/utils';\\n\\nexport interface TextareaProps\\n  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}\\n\\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\\n  ({ className, ...props }, ref) => {\\n    return (\\n      <textarea\\n        className={cn(\\n          'w-full min-h-[80px] rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-black placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50',\\n          className\\n        )}\\n        ref={ref}\\n        {...props}\\n      />\\n    );\\n  }\\n);\\n\\nTextarea.displayName = 'Textarea';\\n\\nexport { Textarea };\\n\",\n    \"contexts/ReflectionContext.tsx\": \"// contexts/ReflectionContext.tsx\\n'use client';\\n\\nimport { createContext, useContext, useState } from 'react';\\nimport { ValuesCard } from '@/lib/types';\\n\\ninterface ReflectionState {\\n  story: string;\\n  photo_url?: string;\\n  values_card?: ValuesCard;\\n  share_key?: string;\\n  session_id?: string;  // Add session_id to state\\n}\\n\\nconst defaultState: ReflectionState = {\\n  story: '',\\n};\\n\\nconst ReflectionContext = createContext<{\\n  state: ReflectionState;\\n  updateState: (updates: Partial<ReflectionState>) => void;\\n} | null>(null);\\n\\nexport function ReflectionProvider({ children }: { children: React.ReactNode }) {\\n  const [state, setState] = useState<ReflectionState>(() => {\\n    // Initialize session_id on first load\\n    return {\\n      ...defaultState,\\n      session_id: crypto.randomUUID()\\n    };\\n  });\\n\\n  const updateState = (updates: Partial<ReflectionState>) => {\\n    setState(prev => ({\\n      ...prev,\\n      ...updates,\\n      // Preserve session_id unless explicitly changed\\n      session_id: updates.session_id || prev.session_id,\\n      values_card: updates.values_card || prev.values_card\\n    }));\\n  };\\n\\n  return (\\n    <ReflectionContext.Provider value={{ state, updateState }}>\\n      {children}\\n    </ReflectionContext.Provider>\\n  );\\n}\\n\\nexport const useReflection = () => {\\n  const context = useContext(ReflectionContext);\\n  if (!context) {\\n    throw new Error('useReflection must be used within a ReflectionProvider');\\n  }\\n  return context;\\n};\",\n    \"app/friend/[shareKey]/page.tsx\": \"// /app/friend/[sharekey]/page.tsx\\n\\n'use client';\\n\\nimport { useState, useEffect } from 'react';\\nimport { useRouter } from 'next/navigation';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { supabase } from '@/lib/supabase';\\nimport { ChatUI } from '@/components/reflection/shared/ChatUI';\\nimport ValuesCard from '@/components/reflection/ValuesCard';\\nimport type { ValuesCard as ValuesCardType, FriendPerspective } from '@/lib/types';\\nimport { FRIEND_REFLECTION_PROMPT } from '@/lib/prompts';\\nimport { use } from 'react';\\nimport FriendValuesCard from '@/components/reflection/FriendValuesCard';\\n\\nexport default function FriendReflectionPage({ \\n  params \\n}: { \\n  params: Promise<{ sharekey: string }> \\n}) {\\n  const router = useRouter();\\n  const resolvedParams = use(params);\\n  const sharekey = resolvedParams.sharekey;\\n\\n  \\n\\n  const [originalCard, setOriginalCard] = useState<ValuesCardType | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n  const [showChat, setShowChat] = useState(false);\\n  const [story, setStory] = useState('');\\n  const [friendCard, setFriendCard] = useState<FriendPerspective | null>(null);\\n  const [isSubmitting, setIsSubmitting] = useState(false);\\n\\n  useEffect(() => {\\n    async function loadCard() {\\n      try {\\n        const { data, error } = await supabase\\n          .from('values_cards')\\n          .select('*')\\n          .eq('share_key', sharekey)\\n          .single();\\n\\n        if (error) throw error;\\n        if (data) {\\n          setOriginalCard(data as ValuesCardType);\\n        }\\n      } catch (err) {\\n        console.error('Error loading card:', err);\\n        setError('Unable to load this reflection invitation');\\n      } finally {\\n        setLoading(false);\\n      }\\n    }\\n\\n    loadCard();\\n  }, [sharekey]);\\n\\n  const handleStorySubmit = () => {\\n    if (!story.trim() || isSubmitting) return;\\n    setShowChat(true);\\n  };\\n\\n  const [isSaving, setIsSaving] = useState(false);\\n  const [sessionId] = useState(() => crypto.randomUUID());  // Add session tracking\\n\\n// Update the handleChatComplete function in app/friend/[shareKey]/page.tsx\\n\\nconst handleChatComplete = async (valuesCard: any) => {\\n    if (!originalCard?.id || isSaving) {\\n      console.log('Skipping duplicate save...');\\n      return;\\n    }\\n    \\n    try {\\n      setIsSaving(true);\\n      \\n      const friendPerspective = {\\n        card_id: originalCard.id,\\n        perspective_id: crypto.randomUUID(),\\n        title: valuesCard.title || 'Untitled Perspective',\\n        description: valuesCard.description || 'No description provided',\\n        attention_patterns: valuesCard.attention_patterns || [],\\n        practices: valuesCard.practices || [],\\n        story: story || 'No story provided',\\n        photo_url: state.photo_url || null,\\n        original_card: originalCard || null,\\n           };\\n      \\n      const { data, error } = await supabase\\n        .from('friend_perspectives')\\n        .insert([friendPerspective])\\n        .select()\\n        .single();\\n  \\n      if (error) {\\n        console.error('Supabase error:', error);\\n        throw error;\\n      }\\n  \\n      if (data) {\\n        setFriendCard(data as FriendPerspective);\\n      }\\n    } catch (err) {\\n      console.error('Error saving perspective:', err);\\n      if (err instanceof Error) {\\n        alert(`Failed to save your reflection: ${err.message}`);\\n      } else {\\n        alert('Failed to save your reflection. Please try again.');\\n      }\\n    } finally {\\n      setIsSaving(false);\\n    }\\n  };\\n    \\n  const startOwnReflection = () => {\\n    router.push('/');\\n  };\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <div className=\\\"animate-pulse space-y-4\\\">\\n            <div className=\\\"h-12 bg-gray-200 rounded w-3/4 mx-auto\\\"></div>\\n            <div className=\\\"h-64 bg-gray-200 rounded\\\"></div>\\n          </div>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  if (error || !originalCard) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardContent className=\\\"p-8 text-center\\\">\\n              <h2 className=\\\"text-xl text-red-600 font-semibold\\\">\\n                {error || 'Reflection invitation not found'}\\n              </h2>\\n              <p className=\\\"text-gray-600 mt-2\\\">\\n                This link might be invalid or have expired.\\n              </p>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  const initialChatMessage = `Thank you for sharing this story. Let's explore what you notice about their character and how they show up in the world. What stands out to you about their way of being in this memory?`;\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        {showChat || friendCard ? (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                Share Your Perspective\\n              </h1>\\n            </header>\\n            <main className=\\\"p-6\\\">\\n              {showChat && !friendCard && (\\n                <Card>\\n                  <CardContent>\\n                    <ChatUI\\n                      onComplete={handleChatComplete}\\n                      className=\\\"min-h-[400px]\\\"\\n                      initialMessage={initialChatMessage}\\n                      systemPrompt={FRIEND_REFLECTION_PROMPT}\\n                    />\\n                  </CardContent>\\n                </Card>\\n              )}\\n\\n            {friendCard && (\\n            <div className=\\\"space-y-6\\\">\\n                <div className=\\\"bg-blue-50 p-6 rounded-lg text-center\\\">\\n                <h2 className=\\\"text-xl font-semibold text-blue-900 mb-2\\\">\\n                    Thank you for sharing your perspective!\\n                </h2>\\n                <p className=\\\"text-blue-800\\\">\\n                    Your reflection has been shared with them.\\n                </p>\\n                </div>\\n                \\n                <FriendValuesCard \\n                {...friendCard}\\n                />\\n\\n                <div className=\\\"mt-8 text-center space-y-4\\\">\\n                <p className=\\\"text-gray-700\\\">\\n                    Would you like to reflect on your own meaningful experiences?\\n                </p>\\n                <Button\\n                    onClick={startOwnReflection}\\n                    className=\\\"bg-blue-500 hover:bg-blue-600 text-white px-6\\\"\\n                >\\n                    Start My Reflection\\n                </Button>\\n                </div>\\n            </div>\\n            )}\\n            </main>\\n          </div>\\n        ) : (\\n          <div className=\\\"rounded-lg bg-card shadow-lg\\\">\\n            <header className=\\\"p-6 border-b border-gray-200\\\">\\n              <h1 className=\\\"text-2xl font-bold text-text-dark text-center\\\">\\n                You've Been Invited to Share\\n              </h1>\\n            </header>\\n            <main className=\\\"p-6 space-y-6\\\">\\n              <div className=\\\"bg-blue-50 p-6 rounded-lg\\\">\\n                <h2 className=\\\"text-xl font-semibold text-blue-900 mb-4\\\">\\n                  Someone values your perspective\\n                </h2>\\n                <p className=\\\"text-blue-800\\\">\\n                  You've been invited to share what you notice about someone's character and way of being. Your perspective can help them understand their impact on others.\\n                </p>\\n              </div>\\n\\n              <div className=\\\"space-y-4\\\">\\n                <p className=\\\"text-gray-700\\\">\\n                  Think about a meaningful moment with this person. What happened? \\n                  What did you notice about their way of being and how it affected those around them?\\n                </p>\\n                \\n                <textarea\\n                  value={story}\\n                  onChange={(e) => setStory(e.target.value)}\\n                  placeholder=\\\"Share your story...\\\"\\n                  className=\\\"w-full p-4 rounded-lg border border-gray-300 bg-white text-black placeholder-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none min-h-[200px]\\\"\\n                />\\n              </div>\\n\\n              <button\\n                onClick={handleStorySubmit}\\n                disabled={!story.trim() || isSubmitting}\\n                className={`w-full py-2 rounded-lg font-medium transition-colors ${\\n                  story.trim() && !isSubmitting\\n                    ? 'bg-blue-500 text-white hover:bg-blue-600'\\n                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'\\n                }`}\\n              >\\n                {isSubmitting ? 'Submitting...' : 'Continue'}\\n              </button>\\n            </main>\\n          </div>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\",\n    \"app/card/[shareKey]/page.tsx\": \"// app/card/[shareKey]/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { supabase } from '@/lib/supabase';\\nimport type { ValuesCard as ValuesCardType, FriendPerspective } from '@/lib/types';\\nimport { use } from 'react';\\nimport Link from 'next/link';\\nimport { User } from '@supabase/supabase-js';\\n\\ntype PageParams = {\\n  params: Promise<{ sharekey: string }>\\n};\\n\\nexport default function CardViewPage({ params }: PageParams) {\\n  const resolvedParams = use(params);\\n  const sharekey = resolvedParams.sharekey;\\n  \\n  const [card, setCard] = useState<ValuesCardType | null>(null);\\n  const [friendPerspectives, setFriendPerspectives] = useState<FriendPerspective[]>([]);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n  const [user, setUser] = useState<User | null>(null);\\n  const [isOwner, setIsOwner] = useState(false);\\n\\n  useEffect(() => {\\n    // Check auth state\\n    supabase.auth.getSession().then(({ data: { session } }) => {\\n      if (session?.user) {\\n        setUser(session.user);\\n      }\\n    });\\n  }, []);\\n\\n  useEffect(() => {\\n    async function loadCardAndPerspectives() {\\n      if (!sharekey) {\\n        setError('No share key provided');\\n        setLoading(false);\\n        return;\\n      }\\n\\n      try {\\n        // Load the values card\\n        const { data: cardData, error: cardError } = await supabase\\n          .from('values_cards')\\n          .select('*')\\n          .eq('share_key', sharekey)\\n          .single();\\n\\n        if (cardError) {\\n          console.error('Error loading card:', cardError);\\n          throw cardError;\\n        }\\n\\n        if (!cardData) {\\n          throw new Error('Card not found');\\n        }\\n\\n        setCard(cardData as ValuesCardType);\\n        setIsOwner(user?.id === cardData.user_id);\\n\\n        // Load friend perspectives for this card\\n        const { data: perspectivesData, error: perspectivesError } = await supabase\\n          .from('friend_perspectives')\\n          .select('*')\\n          .eq('card_id', cardData.id)\\n          .order('created_at', { ascending: false });\\n\\n        if (perspectivesError) {\\n          console.error('Error loading perspectives:', perspectivesError);\\n        } else {\\n          setFriendPerspectives(perspectivesData as FriendPerspective[] || []);\\n        }\\n      } catch (err) {\\n        console.error('Error loading data:', err);\\n        setError(err instanceof Error ? err.message : 'Unable to load the values card');\\n      } finally {\\n        setLoading(false);\\n      }\\n    }\\n\\n    loadCardAndPerspectives();\\n  }, [sharekey, user]);\\n\\n  // ... loading and error states remain the same ...\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        {/* User status bar */}\\n        <div className=\\\"mb-6 flex justify-between items-center\\\">\\n          {user ? (\\n            <div className=\\\"flex items-center gap-4\\\">\\n              <span className=\\\"text-sm text-gray-600\\\">\\n                Logged in as {user.email}\\n              </span>\\n              <Link href=\\\"/profile\\\">\\n                <Button variant=\\\"outline\\\" size=\\\"sm\\\">\\n                  View Profile\\n                </Button>\\n              </Link>\\n            </div>\\n          ) : (\\n            <Link href=\\\"/\\\">\\n              <Button variant=\\\"outline\\\" size=\\\"sm\\\">\\n                Go home\\n              </Button>\\n            </Link>\\n          )}\\n        </div>\\n\\n        {/* Values Card Display */}\\n        <Card className=\\\"w-full bg-white shadow-lg mb-8\\\">\\n          <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n            <h1 className=\\\"text-3xl font-bold text-gray-900 text-center\\\">{card?.title}</h1>\\n          </CardHeader>\\n          <CardContent className=\\\"space-y-6 p-8\\\">\\n{/* Photo Section */}\\n{card?.photo_url && (\\n  <div\\n    onClick={() => {\\n      window.open(card.photo_url, '_blank');\\n    }}\\n    className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner cursor-pointer\\\"\\n  >\\n    <img\\n      src={card.photo_url}\\n      alt=\\\"Meaningful moment\\\"\\n      className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n    />\\n  </div>\\n)}  {/* Description */}\\n  {card?.description && (\\n    <div>\\n      <h3 className=\\\"text-xl font-bold text-gray-900\\\">Description</h3>\\n      <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{card.description}</p>\\n    </div>\\n  )}\\n\\n  {/* Attention Patterns */}\\n  {card?.attention_patterns?.length > 0 && (\\n    <div>\\n      <h3 className=\\\"text-xl font-bold text-gray-900\\\">What You Pay Attention To</h3>\\n      <ul className=\\\"space-y-2\\\">\\n        {card.attention_patterns.map((pattern, index) => (\\n          <li key={index} className=\\\"text-gray-700\\\">\\n            <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n            {pattern}\\n          </li>\\n        ))}\\n      </ul>\\n    </div>\\n  )}\\n\\n  {/* Practices */}\\n  {card?.practices?.length > 0 && (\\n    <div>\\n      <h3 className=\\\"text-xl font-bold text-gray-900\\\">Ways to Live This Value</h3>\\n      <ul className=\\\"space-y-2\\\">\\n        {card.practices.map((practice, index) => (\\n          <li key={index} className=\\\"text-gray-700\\\">\\n            <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n            {practice}\\n          </li>\\n        ))}\\n      </ul>\\n    </div>\\n  )}\\n\\n  {/* Value Promise */}\\n  {card?.value_promise && (\\n    <div>\\n      <h3 className=\\\"text-xl font-bold text-gray-900\\\">Your Value Promise</h3>\\n      <p className=\\\"text-gray-700\\\">{card.value_promise}</p>\\n    </div>\\n  )}\\n\\n  {/* Photo */}\\n  {card?.photo_url && (\\n    <div className=\\\"w-full aspect-video relative overflow-hidden rounded-lg shadow-inner\\\">\\n      <img\\n        src={card.photo_url}\\n        alt=\\\"Meaningful moment\\\"\\n        className=\\\"object-cover w-full h-full hover:opacity-90 transition-opacity\\\"\\n      />\\n    </div>\\n  )}\\n</CardContent>\\n        </Card>\\n\\n        {/* Friend Perspectives Section */}\\n        {friendPerspectives.length > 0 && (\\n          <Card className=\\\"w-full bg-white shadow-lg mt-8\\\">\\n            <CardHeader>\\n              <h2 className=\\\"text-2xl font-bold text-gray-900\\\">\\n                Values people see in the person who shared this value\\n              </h2>\\n            </CardHeader>\\n            <CardContent className=\\\"p-8\\\">\\n              <div className=\\\"space-y-4\\\">\\n                {friendPerspectives.map((perspective) => (\\n                  <Link \\n                    key={perspective.id} \\n                    href={`/perspective/${perspective.id}`}\\n                  >\\n                    <div className=\\\"p-4 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors\\\">\\n                      <h3 className=\\\"text-xl font-semibold text-gray-900 mb-2\\\">\\n                        {perspective.title}\\n                      </h3>\\n                      <p className=\\\"text-gray-600 line-clamp-2\\\">\\n                        {perspective.description}\\n                      </p>\\n                    </div>\\n                  </Link>\\n                ))}\\n              </div>\\n            </CardContent>\\n          </Card>\\n        )}\\n      </div>\\n    </div>\\n  );\\n}\",\n    \"app/perspective/[id]/page.tsx\": \"// app/perspective/[id]/page.tsx\\n'use client';\\n\\nimport { useEffect, useState } from 'react';\\nimport { Card, CardHeader, CardContent } from '@/components/ui/card';\\nimport { Button } from '@/components/ui/button';\\nimport { supabase } from '@/lib/supabase';\\nimport type { FriendPerspective } from '@/lib/types';\\nimport { use } from 'react';\\nimport Link from 'next/link';\\nimport { ChevronLeft } from 'lucide-react';\\n\\ntype PageParams = {\\n  params: Promise<{ id: string }>\\n};\\n\\nexport default function PerspectiveViewPage({ params }: PageParams) {\\n  const resolvedParams = use(params);\\n  const perspectiveId = resolvedParams.id;\\n  \\n  const [perspective, setPerspective] = useState<FriendPerspective | null>(null);\\n  const [loading, setLoading] = useState(true);\\n  const [error, setError] = useState<string | null>(null);\\n\\n  useEffect(() => {\\n    async function loadPerspective() {\\n      try {\\n        const { data, error } = await supabase\\n          .from('friend_perspectives')\\n          .select('*, values_cards!inner(*)')\\n          .eq('id', perspectiveId)\\n          .single();\\n\\n        if (error) throw error;\\n        if (!data) throw new Error('Perspective not found');\\n\\n        setPerspective(data as FriendPerspective);\\n      } catch (err) {\\n        console.error('Error loading perspective:', err);\\n        setError(err instanceof Error ? err.message : 'Unable to load this perspective');\\n      } finally {\\n        setLoading(false);\\n      }\\n    }\\n\\n    loadPerspective();\\n  }, [perspectiveId]);\\n\\n  if (loading) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <div className=\\\"animate-pulse space-y-4\\\">\\n            <div className=\\\"h-12 bg-gray-200 rounded w-3/4 mx-auto\\\"></div>\\n            <div className=\\\"h-64 bg-gray-200 rounded\\\"></div>\\n          </div>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  if (error || !perspective) {\\n    return (\\n      <div className=\\\"min-h-screen bg-background py-12\\\">\\n        <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n          <Card className=\\\"w-full bg-white shadow-lg\\\">\\n            <CardContent className=\\\"p-8 text-center\\\">\\n              <h2 className=\\\"text-xl text-red-600 font-semibold\\\">\\n                {error || 'Perspective not found'}\\n              </h2>\\n              <p className=\\\"text-gray-600 mt-2\\\">\\n                This perspective might have been removed or the link might be incorrect.\\n              </p>\\n            </CardContent>\\n          </Card>\\n        </div>\\n      </div>\\n    );\\n  }\\n\\n  return (\\n    <div className=\\\"min-h-screen bg-background py-12\\\">\\n      <div className=\\\"max-w-4xl mx-auto px-4\\\">\\n        <Card className=\\\"w-full bg-white shadow-lg\\\">\\n          <CardHeader className=\\\"border-b border-gray-100 bg-gray-50\\\">\\n            <div className=\\\"flex items-center mb-4\\\">\\n              <Link \\n                href={`/card/${perspective.original_card.share_key}`}\\n                className=\\\"text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1\\\"\\n              >\\n                <ChevronLeft className=\\\"w-4 h-4\\\" />\\n                Back to Values Card\\n              </Link>\\n            </div>\\n            <h1 className=\\\"text-3xl font-bold text-gray-900\\\">\\n              {perspective.title}\\n            </h1>\\n          </CardHeader>\\n          <CardContent className=\\\"space-y-6 p-8\\\">\\n            <div className=\\\"bg-blue-50 p-4 rounded-lg\\\">\\n              <p className=\\\"text-blue-900 text-lg\\\">\\n                A reflection on how they express their values through their actions and way of being\\n              </p>\\n            </div>\\n\\n            {/* Story/Memory Section */}\\n            {perspective.story && (\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">A Meaningful Moment</h3>\\n                <div className=\\\"bg-gray-50 p-4 rounded-lg\\\">\\n                  <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{perspective.story}</p>\\n                </div>\\n              </div>\\n            )}\\n\\n            {/* Description Section */}\\n            <div className=\\\"space-y-3\\\">\\n              <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Reflection</h3>\\n              <p className=\\\"text-gray-700 text-lg leading-relaxed\\\">{perspective.description}</p>\\n            </div>\\n\\n            {/* What They Notice Section */}\\n            {perspective.attention_patterns && perspective.attention_patterns.length > 0 && (\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">What Others Notice</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {perspective.attention_patterns.map((pattern, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {pattern}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n            )}\\n\\n            {/* Impact Section */}\\n            {perspective.practices && perspective.practices.length > 0 && (\\n              <div className=\\\"space-y-3\\\">\\n                <h3 className=\\\"font-semibold text-gray-900 text-xl\\\">Their Impact on Others</h3>\\n                <ul className=\\\"space-y-2\\\">\\n                  {perspective.practices.map((practice, i) => (\\n                    <li key={i} className=\\\"text-gray-700 flex items-start\\\">\\n                      <span className=\\\"text-blue-500 mr-2\\\">•</span>\\n                      {practice}\\n                    </li>\\n                  ))}\\n                </ul>\\n              </div>\\n            )}\\n\\n            {/* Footer Navigation */}\\n            <div className=\\\"border-t pt-6 mt-8\\\">\\n              <Link href={`/card/${perspective.original_card.share_key}`}>\\n                <Button className=\\\"w-full bg-blue-500 hover:bg-blue-600 text-white\\\">\\n                  Return to Values Card\\n                </Button>\\n              </Link>\\n            </div>\\n          </CardContent>\\n        </Card>\\n      </div>\\n    </div>\\n  );\\n}\"\n  },\n  \"dependencies\": {\n    \"dependencies\": {\n      \"@headlessui/react\": \"^2.2.0\",\n      \"@heroicons/react\": \"^2.2.0\",\n      \"@supabase/auth-helpers-nextjs\": \"^0.10.0\",\n      \"@supabase/supabase-js\": \"^2.47.10\",\n      \"ai\": \"^4.0.22\",\n      \"class-variance-authority\": \"^0.7.1\",\n      \"clsx\": \"^2.1.1\",\n      \"lucide-react\": \"^0.469.0\",\n      \"next\": \"15.1.3\",\n      \"openai\": \"^4.77.0\",\n      \"react\": \"^19.0.0\",\n      \"react-dom\": \"^19.0.0\",\n      \"tailwind-merge\": \"^2.6.0\",\n      \"vercel\": \"^39.2.2\"\n    },\n    \"devDependencies\": {\n      \"@eslint/eslintrc\": \"^3\",\n      \"@types/node\": \"^20\",\n      \"@types/react\": \"^19\",\n      \"@types/react-dom\": \"^19\",\n      \"eslint\": \"^9\",\n      \"eslint-config-next\": \"15.1.3\",\n      \"postcss\": \"^8\",\n      \"tailwindcss\": \"^3.4.1\",\n      \"typescript\": \"^5\"\n    }\n  },\n  \"missingFiles\": [\n    \"components/reflection/AuthAction.tsx\"\n  ]\n}",
      "created_at": "2024-12-29T01:00:01.731668",
      "sequence_order": 1,
      "parent_id": "97c7a16a-020e-4893-8240-0317604dfbcc",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "c89c5c85-e812-4d14-8baf-6c09d3054fcf",
      "role": "tool",
      "content": "**Clarifying distinctions**\n\nI'm thinking through the differences between session_id and share_key, their necessity, and exploring unification. Addressing code updates and AuthAction.tsx is crucial to resolving login saving issues.\n\n**Weighing integration options**\n\nI'm exploring whether to merge session_id and share_key into a single field for simplicity or to keep them distinct yet unified through code logic, considering their different use cases.\n\n**Understanding roles**\n\nSession_id manages transient reflections, while share_key facilitates sharing. Unifying them might cause conflicts due to distinct purposes, especially during login-related issues.\n\n**Mapping out roles**\n\nSession_id manages temporary user sessions, while share_key ensures public sharing. Unifying them might be tricky, especially for sharing reflections with friends.\n\n**Evaluating unification**\n\nUnifying session_id and share_key might lead to confusion given their distinct roles: session_id manages ephemeral sessions, while share_key is for public or friend-sharing.\n\n**Tracking login status**\n\nNavigating login requirements, using session_id for guests and user_id for registered users, ensures accurate reflection data storage. This approach effectively addresses the user's saving issues.\n\n**Tracking user actions**\n\nI’m considering tracking login status to address reflection data, using session_id for guests and user_id for registered users, ensuring accurate storage. Progress is being made towards a solution.",
      "created_at": "2024-12-29T01:00:44.866168",
      "sequence_order": 2,
      "parent_id": "aaa21107-a881-452e-884a-0195015fec3e",
      "metadata": {
        "status": "finished_successfully",
        "weight": 0,
        "end_turn": null
      }
    },
    {
      "id": "e05113bc-46c4-4977-bd01-64ae49e171ac",
      "role": "assistant",
      "content": "**Josephine (White Hat)**  \nSession IDs and share keys serve different but complementary purposes in your current setup:\n\n1. **Session ID**  \n   - Used as an _ephemeral_ identifier for a user who may not be logged in yet.  \n   - Allows you to store reflections (Values Card data) before a user creates an account or signs in.  \n   - Once the user logs in, you can update those records to associate them with their `user_id` if desired.\n\n2. **Share Key**  \n   - Used as a **public** or **semi-public** identifier to share the card (or reflection) with friends.  \n   - It allows external users to view (and possibly comment on) the reflections without needing the author’s authentication.  \n   - Essentially functions like a “public link” or “invite code.”\n\n**Claude (Green Hat)**  \nIf you want to simplify, you _could_ unify them by always creating a single random ID that also serves as the “sharable link,” whether or not the user is logged in. For example:\n\n- On new reflection creation, generate **one** `randomUUID()`, store it in a single column (e.g., `share_key`), and use that key for both ephemeral user references and for sharing with friends.\n- If the user never logs in, this share key still links to the card.  \n- If the user _does_ log in, you can then associate the existing record with `user_id` in the database, and the same `share_key` remains used for sharing.\n\nHowever, that can lead to a few complexities:\n\n- You have only one identifier, so you’ll need to handle the scenario of merging “anonymous reflections” with an authenticated user if/when they log in.  \n- If you do want to keep a clear distinction between ephemeral sessions vs. publicly shareable links, it’s often _cleaner_ to keep them separate.\n\n**Prunella (Black Hat)**  \nPossible pitfalls if you unify:\n\n- You risk confusion when you only want to “privately track” a user’s session but also end up creating a publicly shareable link for everything.  \n- If you unify them, you’ll have to carefully handle or revoke the link if the user wants the reflection to be private again.  \n- If a user reuses the same share key for ephemeral sessions and never finalizes or logs in, it could linger as a public link with partial data.\n\n**Percy (Yellow Hat)**  \nThe upside of unifying them:\n\n- Less code and fewer columns to worry about.  \n- Fewer places to cause confusion on the front end—just one key.  \n- If your user experience is mostly about sharing reflections publicly or with friends, a single “key” can keep it simple.\n\n**Cyril (Red Hat)**  \nIt can feel more natural and less cumbersome to have just one ID: “Here’s the unique link that represents this reflection.” Then, once the user logs in, that same link becomes associated with their account. From a user’s perspective, that’s a clean, streamlined approach.\n\n**Quackers (Blue Hat) — Synthesis and Plan**  \n1. **If you want to keep them separate (status quo)**  \n   - **session_id** remains your ephemeral or “anonymous user’s key,” used to store partial reflections.  \n   - **share_key** is used for publicly sharing with others.  \n   - When the user logs in, you copy data from `session_id` → a record bound to their `user_id`. You can keep or remove the ephemeral record as desired.\n\n2. **If you want to unify them**  \n   - Remove `session_id` entirely.  \n   - Whenever you create a new reflection (logged in or not), generate one random UUID as `share_key`.  \n   - If not logged in, treat that `share_key` as the ephemeral identifier.  \n   - If the user logs in afterward, update the row in the database to add the `user_id`, but **keep** the same `share_key` for continuity.  \n   - Your code and DB need to handle the use case: “If `user_id` is null, this record belongs to an anonymous user; if `user_id` is set, it belongs to that user.”\n\nBelow is an **example** refactor showing how to unify under **`share_key`** and remove `session_id` from `ReflectionContext`. It includes the relevant changes in the context and pages that do the upserts. (Note: This is a _simplified_ version focusing on the key pieces rather than every single file, so you can see the main idea.)\n\n---\n\n### 1. **Remove `session_id` from your `ReflectionContext.tsx`**\n\n```ts\n// contexts/ReflectionContext.tsx\n'use client';\n\nimport { createContext, useContext, useState } from 'react';\nimport { ValuesCard } from '@/lib/types';\n\ninterface ReflectionState {\n  story: string;\n  photo_url?: string;\n  values_card?: ValuesCard;\n  share_key?: string; // We’ll keep share_key as the single unique ID\n}\n\nconst defaultState: ReflectionState = {\n  story: '',\n};\n\nconst ReflectionContext = createContext<{\n  state: ReflectionState;\n  updateState: (updates: Partial<ReflectionState>) => void;\n} | null>(null);\n\nexport function ReflectionProvider({ children }: { children: React.ReactNode }) {\n  const [state, setState] = useState<ReflectionState>(() => {\n    return {\n      ...defaultState,\n      share_key: crypto.randomUUID(), // Start with one random key\n    };\n  });\n\n  const updateState = (updates: Partial<ReflectionState>) => {\n    setState((prev) => ({\n      ...prev,\n      ...updates,\n      // preserve share_key unless explicitly changed\n      share_key: updates.share_key ?? prev.share_key,\n    }));\n  };\n\n  return (\n    <ReflectionContext.Provider value={{ state, updateState }}>\n      {children}\n    </ReflectionContext.Provider>\n  );\n}\n\nexport const useReflection = () => {\n  const context = useContext(ReflectionContext);\n  if (!context) {\n    throw new Error('useReflection must be used within a ReflectionProvider');\n  }\n  return context;\n};\n```\n\n### 2. **Refactor Upsert Logic**  \nWherever you previously used `session_id` to upsert, switch to `share_key`. For example, in `app/reflection/page.tsx`, inside `handleChatComplete`:\n\n```tsx\n// app/reflection/page.tsx\n// ...\nconst handleChatComplete = async (valuesCard: any) => {\n  if (isSaving) {\n    console.log('Skipping duplicate save...');\n    return;\n  }\n  setIsSaving(true);\n\n  try {\n    const { title, description, attention_patterns, practices } = valuesCard;\n    const updates = {\n      title: title || 'Untitled Card',\n      description: description || '',\n      attention_patterns: attention_patterns || [],\n      practices: practices || [],\n      story: state.story || '',\n      photo_url: state.photo_url || null,\n      is_public: false,\n      // instead of session_id:\n      share_key: state.share_key,\n    };\n\n    // Now upsert on share_key\n    const { data, error } = await supabase\n      .from('values_cards')\n      .upsert(updates, {\n        onConflict: 'share_key', // Use the share_key for deduplication\n        ignoreDuplicates: false,\n      })\n      .select('*')\n      .single();\n\n    if (error) {\n      console.error('Error saving card:', error);\n      throw error;\n    }\n\n    if (!data) {\n      throw new Error('No data returned from upsert operation');\n    }\n\n    console.log('Card saved successfully:', data);\n    updateState({ values_card: data });\n  } catch (err) {\n    console.error('Error saving card:', err);\n    alert('An error occurred while saving your values card. Please try again.');\n  } finally {\n    setIsSaving(false);\n  }\n};\n```\n\n### 3. **Update the `ValuesCard` Edits**  \nWhenever we do an update, use `share_key` (or the ID) to find the card. For instance:\n\n```ts\n// still in app/reflection/page.tsx (handleUpdateCard function)\nconst handleUpdateCard = async (updates: Partial<ValuesCardType>) => {\n  if (!state.share_key && !state.values_card?.id) return false;\n\n  try {\n    // Start a retry loop for concurrency, if needed\n    let retries = 3;\n    while (retries > 0) {\n      const { data, error } = await supabase\n        .from('values_cards')\n        .update(updates)\n        .match(\n          state.share_key\n            ? { share_key: state.share_key }\n            : { id: state.values_card?.id }\n        )\n        .select('*')\n        .single();\n\n      if (error) {\n        if (error.code === '23505' && retries > 1) {\n          await new Promise((resolve) => setTimeout(resolve, 1000));\n          retries--;\n          continue;\n        }\n        throw error;\n      }\n\n      if (!data) {\n        throw new Error('No rows updated. The card might not exist.');\n      }\n\n      updateState({\n        values_card: { ...state.values_card, ...data } as ValuesCardType,\n      });\n      return true;\n    }\n\n    throw new Error('Failed to update after retries');\n  } catch (err) {\n    console.error('Error updating card:', err);\n    alert('Failed to save your changes. Please try again.');\n    return false;\n  }\n};\n```\n\n### 4. **Associate with `user_id` if Logged In**  \nWhen the user logs in, you can do a final “claim” of the reflection by updating the existing record that has `share_key` to also have `user_id = session.user.id`. For example, after `handleLogin` or after verifying the user is logged in, you might do:\n\n```tsx\n// app/page.tsx or somewhere after the user logs in:\nuseEffect(() => {\n  if (user && state.share_key) {\n    // Attempt to set user_id on the existing reflection row with the same share_key\n    supabase\n      .from('values_cards')\n      .update({ user_id: user.id })\n      .eq('share_key', state.share_key)\n      .then(({ error }) => {\n        if (error) {\n          console.error('Could not associate reflection with user:', error);\n        }\n      });\n  }\n}, [user, state.share_key]);\n```\n\nIn short:\n- If a user was anonymous, the reflection card is identified by `share_key`.\n- Upon login, set `user_id` on the existing row (if it hasn’t been set already).\n- Going forward, you can load that reflection by `user_id` in the profile, or by `share_key` if it’s shared publicly.\n\n---\n\n## Summing Up\n- **Difference**: \n  - **Session ID** was ephemeral for tracking a user’s reflection without requiring a Supabase-auth `user_id`.  \n  - **Share Key** was a publicly shareable link.  \n- **Do we need both?**  \n  - Strictly speaking, you can unify them into a single “key.” But in your current design, they do serve slightly different roles.  \n- **Saving issues after logging in** often result from confusion about which column (session_id vs. user_id) to use. Once the user logs in, you should claim the ephemeral reflection row under `user_id` to consistently fetch it in the future.\n\nHopefully this clarifies how to either unify or keep them separate while ensuring your reflections save properly. If you go for unification, the included code examples give you a starting point for removing `session_id` and relying solely on `share_key`. Good luck!",
      "created_at": "2024-12-29T01:00:44.866322",
      "sequence_order": 3,
      "parent_id": "c89c5c85-e812-4d14-8baf-6c09d3054fcf",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": true
      }
    }
  ]
}