{
  "id": "bc29dfb6-1db1-44b0-a467-b402262973b1",
  "source": "chatgpt",
  "title": "Debugging TypeError in Streamlit",
  "created_at": "2023-05-29T15:18:44.133908",
  "updated_at": "2023-05-29T15:22:54",
  "summary": null,
  "message_count": 4,
  "messages": [
    {
      "id": "aaa277c1-15e5-490d-897c-a47f9a21187f",
      "role": "user",
      "content": "TypeError: This app has encountered an error. The original error message is redacted to prevent data leaks. Full error details have been recorded in the logs (if you're on Streamlit Cloud, click on 'Manage app' in the lower right of your app).\nTraceback:\nFile \"/home/appuser/venv/lib/python3.9/site-packages/streamlit/runtime/scriptrunner/script_runner.py\", line 565, in _run_script\n    exec(code, module.__dict__)\nFile \"/app/chatwithassessments/streamlit_app.py\", line 82, in <module>\n    main()\nFile \"/app/chatwithassessments/streamlit_app.py\", line 72, in main\n    docs = VectorStore.similarity_search(query=query, k=3)\nFile \"/home/appuser/venv/lib/python3.9/site-packages/langchain/vectorstores/faiss.py\", line 226, in similarity_search\n    docs_and_scores = self.similarity_search_with_score(query, k)\nFile \"/home/appuser/venv/lib/python3.9/site-packages/langchain/vectorstores/faiss.py\", line 196, in similarity_search_with_score\n    docs = self.similarity_search_with_score_by_vector(embedding, k)\nFile \"/home/appuser/venv/lib/python3.9/site-packages/langchain/vectorstores/faiss.py\", line 170, in similarity_search_with_score_by_vector\n    scores, indices = self.index.search(np.array([embedding], dtype=np.float32), k)\nMy code:\n\nimport streamlit as st\nimport pickle\nfrom PyPDF2 import PdfReader\nfrom streamlit_extras.add_vertical_space import add_vertical_space\nfrom langchain.text_splitter import RecursiveCharacterTextSplitter\nfrom langchain.embeddings.openai import OpenAIEmbeddings\nfrom langchain.vectorstores import FAISS\nfrom langchain.llms import OpenAI\nfrom langchain.chains.question_answering import load_qa_chain\nfrom langchain.callbacks import get_openai_callback\nimport os\n \n# Sidebar contents\nwith st.sidebar:\n    st.title('Bloom Assessment Dialog App')\n    st.markdown('''\n    ## About\n    This use this chatbot to talk with your Bloom Data:\n    ''')\n    add_vertical_space(5)\n    st.write('Made with ‚ù§Ô∏è by [Bloom.pm](https://bloom.pm/)')\n \n \ndef main():\n    st.header(\"Chat with your assessment data üí¨\")\n \n \n    # upload a PDF file\n    pdf = st.file_uploader(\"Link to your google drive with your assessment data\", type='pdf')\n \n    # st.write(pdf)\n    if pdf is not None:\n        pdf_reader = PdfReader(pdf)\n        \n        text = \"\"\n        for page in pdf_reader.pages:\n            text += page.extract_text()\n \n        text_splitter = RecursiveCharacterTextSplitter(\n            chunk_size=1000,\n            chunk_overlap=200,\n            length_function=len\n            )\n        chunks = text_splitter.split_text(text=text)\n \n        # # embeddings\n        store_name = pdf.name[:-4]\n        st.write(f'{store_name}')\n        # st.write(chunks)\n \n        if os.path.exists(f\"{store_name}.pkl\"):\n            with open(f\"{store_name}.pkl\", \"rb\") as f:\n                VectorStore = pickle.load(f)\n            # st.write('Embeddings Loaded from the Disk')s\n        else:\n            embeddings = OpenAIEmbeddings()\n            VectorStore = FAISS.from_texts(chunks, embedding=embeddings)\n            with open(f\"{store_name}.pkl\", \"wb\") as f:\n                pickle.dump(VectorStore, f)\n \n        # embeddings = OpenAIEmbeddings()\n        # VectorStore = FAISS.from_texts(chunks, embedding=embeddings)\n \n        # Accept user questions/query\n        query = st.text_input(\"Ask questions about your PDF file:\")\n        # st.write(query)\n \n        if query:\n            docs = VectorStore.similarity_search(query=query, k=3)\n \n            llm = OpenAI()\n            chain = load_qa_chain(llm=llm, chain_type=\"stuff\")\n            with get_openai_callback() as cb:\n                response = chain.run(input_documents=docs, question=query)\n                print(cb)\n            st.write(response)\n \nif __name__ == '__main__':\n    main()\n",
      "created_at": "2023-05-29T15:18:44.135239",
      "sequence_order": 0,
      "parent_id": "2fa27cf5-d468-4e2b-a27c-815c5983c6bb",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "e780530c-9a76-4252-ac49-b9e502b48fe3",
      "role": "assistant",
      "content": "The `TypeError` isn't well described in the error message you provided. However, I can provide some potential reasons and solutions.\n\n1. `TypeError` could be due to mismatched data types. In your case, the error seems to happen during the `similarity_search` function call in your `VectorStore` object. Double-check the data type of your `query` variable and ensure it is compatible with what `similarity_search` expects.\n\n2. There might be an issue with your FAISS index not being loaded or initialized correctly, leading to a problem when you try to perform a search operation on it.\n\n3. The `embedding` generated could be incorrect or not in the format that the FAISS search function expects.\n\nTo debug the issue, here are a few steps:\n\n- Before you perform the `similarity_search`, print out the `query` variable and check its data type.\n\n- Check if the FAISS index (`self.index` in your case) has been correctly initialized and loaded before executing the `search` operation.\n\n- Check the format and values of the embeddings. Are they of the expected format and within a valid range?\n\n- If the problem persists, you may need to inspect the internal implementation of the `similarity_search` function and possibly the `search` method of the FAISS index.\n\nI hope this helps you in diagnosing the problem. As the error message is quite generic, you might have to use a process of elimination to identify the cause.",
      "created_at": "2023-05-29T15:19:17.175839",
      "sequence_order": 1,
      "parent_id": "aaa277c1-15e5-490d-897c-a47f9a21187f",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": true
      }
    },
    {
      "id": "aaa29896-207e-4f3a-88f8-2fbaf42238ff",
      "role": "user",
      "content": "2023-05-29 15:19:56.004 Loading faiss.\n2023-05-29 15:19:56.027 Successfully loaded faiss.\n2023-05-29 15:20:19.069 error_code=invalid_api_key error_message= error_param=None error_type=invalid_request_error message='OpenAI API error received' stream_error=False\n2023-05-29 15:20:19.069 Uncaught app exception\nTraceback (most recent call last):\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/streamlit/runtime/scriptrunner/script_runner.py\", line 565, in _run_script\n    exec(code, module.__dict__)\n  File \"/Users/bilalghalib/Projects/scripts/streamChatPDF/app.py\", line 82, in <module>\n    main()\n  File \"/Users/bilalghalib/Projects/scripts/streamChatPDF/app.py\", line 72, in main\n    docs = VectorStore.similarity_search(query=query, k=3)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/vectorstores/faiss.py\", line 226, in similarity_search\n    docs_and_scores = self.similarity_search_with_score(query, k)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/vectorstores/faiss.py\", line 195, in similarity_search_with_score\n    embedding = self.embedding_function(query)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 245, in embed_query\n    embedding = self._embedding_func(text, engine=self.deployment)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 215, in _embedding_func\n    return embed_with_retry(self, input=[text], engine=engine)[\"data\"][0][\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 63, in embed_with_retry\n    return _embed_with_retry(**kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 289, in wrapped_f\n    return self(f, *args, **kw)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 379, in __call__\n    do = self.iter(retry_state=retry_state)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 314, in iter\n    return fut.result()\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/concurrent/futures/_base.py\", line 451, in result\n    return self.__get_result()\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/concurrent/futures/_base.py\", line 403, in __get_result\n    raise self._exception\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 382, in __call__\n    result = fn(*args, **kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 61, in _embed_with_retry\n    return embeddings.client.create(**kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_resources/embedding.py\", line 33, in create\n    response = super().create(*args, **kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_resources/abstract/engine_api_resource.py\", line 153, in create\n    response, _, api_key = requestor.request(\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_requestor.py\", line 230, in request\n    resp, got_stream = self._interpret_response(result, stream)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_requestor.py\", line 624, in _interpret_response\n    self._interpret_response_line(\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_requestor.py\", line 687, in _interpret_response_line\n    raise self.handle_error_response(\nopenai.error.AuthenticationError: <empty message>\n2023-05-29 15:22:25.540 error_code=invalid_api_key error_message= error_param=None error_type=invalid_request_error message='OpenAI API error received' stream_error=False\n2023-05-29 15:22:25.541 Uncaught app exception\nTraceback (most recent call last):\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/streamlit/runtime/scriptrunner/script_runner.py\", line 565, in _run_script\n    exec(code, module.__dict__)\n  File \"/Users/bilalghalib/Projects/scripts/streamChatPDF/app.py\", line 82, in <module>\n    main()\n  File \"/Users/bilalghalib/Projects/scripts/streamChatPDF/app.py\", line 65, in main\n    VectorStore = FAISS.from_texts(chunks, embedding=embeddings)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/vectorstores/faiss.py\", line 384, in from_texts\n    embeddings = embedding.embed_documents(texts)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 234, in embed_documents\n    return self._get_len_safe_embeddings(texts, engine=self.deployment)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 175, in _get_len_safe_embeddings\n    response = embed_with_retry(\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 63, in embed_with_retry\n    return _embed_with_retry(**kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 289, in wrapped_f\n    return self(f, *args, **kw)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 379, in __call__\n    do = self.iter(retry_state=retry_state)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 314, in iter\n    return fut.result()\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/concurrent/futures/_base.py\", line 451, in result\n    return self.__get_result()\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/concurrent/futures/_base.py\", line 403, in __get_result\n    raise self._exception\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/tenacity/__init__.py\", line 382, in __call__\n    result = fn(*args, **kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/langchain/embeddings/openai.py\", line 61, in _embed_with_retry\n    return embeddings.client.create(**kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_resources/embedding.py\", line 33, in create\n    response = super().create(*args, **kwargs)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_resources/abstract/engine_api_resource.py\", line 153, in create\n    response, _, api_key = requestor.request(\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_requestor.py\", line 230, in request\n    resp, got_stream = self._interpret_response(result, stream)\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_requestor.py\", line 624, in _interpret_response\n    self._interpret_response_line(\n  File \"/Users/bilalghalib/mambaforge/envs/myenv/lib/python3.10/site-packages/openai/api_requestor.py\", line 687, in _interpret_response_line\n    raise self.handle_error_response(\nopenai.error.AuthenticationError: <empty message>\n",
      "created_at": "2023-05-29T15:22:54.779456",
      "sequence_order": 2,
      "parent_id": "e780530c-9a76-4252-ac49-b9e502b48fe3",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": null
      }
    },
    {
      "id": "6ecb4492-2dc6-499c-a9b2-07258e1ca871",
      "role": "assistant",
      "content": "It appears there are a couple of issues here:\n\n1. TypeError: This error seems to occur during the similarity search in the FAISS Vector Store. The error message isn't very detailed, but it could be related to the type or format of data being passed into the `.search()` method of the FAISS index. It could also be related to the indexing or retrieval process. Unfortunately, without more specific information, it's difficult to provide a concrete solution.\n\n2. AuthenticationError: There seems to be a problem with the API key for OpenAI. The error message `openai.error.AuthenticationError: <empty message>` suggests that the API key you're using to authenticate requests to the OpenAI API is invalid. You'll need to check the API key you're using and ensure it's correct. If the key is correct, you might need to contact OpenAI support to ensure there's not an issue with your API access.\n\nYou might also want to check if you have the latest versions of the OpenAI and FAISS libraries, as outdated versions might cause unexpected issues.",
      "created_at": "2023-05-29T15:23:17.221933",
      "sequence_order": 3,
      "parent_id": "aaa29896-207e-4f3a-88f8-2fbaf42238ff",
      "metadata": {
        "status": "finished_successfully",
        "weight": 1,
        "end_turn": true
      }
    }
  ]
}